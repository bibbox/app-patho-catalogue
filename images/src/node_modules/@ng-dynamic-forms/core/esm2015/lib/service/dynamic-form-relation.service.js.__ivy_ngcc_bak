import { Inject, Injectable, Injector, Optional } from "@angular/core";
import { FormControl } from "@angular/forms";
import { AND_OPERATOR, DYNAMIC_MATCHERS, OR_OPERATOR } from "./dynamic-form-relation-matchers";
import { startWith } from "rxjs/operators";
import { merge } from "rxjs";
import * as i0 from "@angular/core";
import * as i1 from "./dynamic-form-relation-matchers";
export class DynamicFormRelationService {
    constructor(MATCHERS, injector) {
        this.MATCHERS = MATCHERS;
        this.injector = injector;
    }
    getRelatedFormControls(model, group) {
        const conditionReducer = (controls, condition) => {
            var _a;
            const path = (_a = condition.rootPath) !== null && _a !== void 0 ? _a : condition.id;
            if (!controls.hasOwnProperty(path)) {
                const control = condition.rootPath ? group.root.get(condition.rootPath) : group.get(condition.id);
                control instanceof FormControl ? controls[path] = control : console.warn(`No related form control with id ${condition.id} could be found`);
            }
            return controls;
        };
        const relationReducer = (controls, relation) => relation.when.reduce(conditionReducer, controls);
        return model.relations.reduce(relationReducer, {});
    }
    findRelationByMatcher(relations, matcher) {
        return relations.find(relation => [matcher.match, matcher.opposingMatch].includes(relation.match));
    }
    matchesCondition(relation, relatedFormControls, matcher) {
        var _a;
        const operator = (_a = relation.operator) !== null && _a !== void 0 ? _a : OR_OPERATOR;
        return relation.when.reduce((hasAlreadyMatched, condition, index) => {
            var _a;
            const path = (_a = condition.rootPath) !== null && _a !== void 0 ? _a : condition.id;
            let relatedFormControl;
            for (const [key, control] of Object.entries(relatedFormControls)) {
                if (key === path) {
                    relatedFormControl = control;
                    break;
                }
            }
            if (relatedFormControl && relation.match === matcher.match) {
                if (index > 0 && operator === AND_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                if (index > 0 && operator === OR_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                return condition.value === relatedFormControl.value || condition.status === relatedFormControl.status;
            }
            if (relatedFormControl && relation.match === matcher.opposingMatch) {
                if (index > 0 && operator === AND_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                if (index > 0 && operator === OR_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                return !(condition.value === relatedFormControl.value || condition.status === relatedFormControl.status);
            }
            return false;
        }, false);
    }
    subscribeRelations(model, group, control) {
        const relatedFormControls = this.getRelatedFormControls(model, group);
        const subscriptions = [];
        Object.values(relatedFormControls).forEach(relatedControl => {
            const valueChanges = relatedControl.valueChanges.pipe(startWith(relatedControl.value));
            const statusChanges = relatedControl.statusChanges.pipe(startWith(relatedControl.status));
            subscriptions.push(merge(valueChanges, statusChanges).subscribe(() => {
                this.MATCHERS.forEach(matcher => {
                    const relation = this.findRelationByMatcher(model.relations, matcher);
                    if (relation !== undefined) {
                        const hasMatch = this.matchesCondition(relation, relatedFormControls, matcher);
                        matcher.onChange(hasMatch, model, control, this.injector);
                    }
                });
            }));
        });
        return subscriptions;
    }
}
DynamicFormRelationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function DynamicFormRelationService_Factory() { return new DynamicFormRelationService(i0.ɵɵinject(i1.DYNAMIC_MATCHERS, 8), i0.ɵɵinject(i0.INJECTOR)); }, token: DynamicFormRelationService, providedIn: "root" });
DynamicFormRelationService.decorators = [
    { type: Injectable, args: [{
                providedIn: "root"
            },] }
];
DynamicFormRelationService.ctorParameters = () => [
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [DYNAMIC_MATCHERS,] }] },
    { type: Injector }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1keW5hbWljLWZvcm1zL2NvcmUvc3JjL2xpYi9zZXJ2aWNlL2R5bmFtaWMtZm9ybS1yZWxhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLFdBQVcsRUFBYSxNQUFNLGdCQUFnQixDQUFDO0FBRXhELE9BQU8sRUFDSCxZQUFZLEVBQ1osZ0JBQWdCLEVBRWhCLFdBQVcsRUFDZCxNQUFNLGtDQUFrQyxDQUFDO0FBRTFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFnQixNQUFNLE1BQU0sQ0FBQzs7O0FBTzNDLE1BQU0sT0FBTywwQkFBMEI7SUFFbkMsWUFBMEQsUUFBcUMsRUFDM0UsUUFBa0I7UUFEb0IsYUFBUSxHQUFSLFFBQVEsQ0FBNkI7UUFDM0UsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQUN0QyxDQUFDO0lBRUQsc0JBQXNCLENBQUMsS0FBOEIsRUFBRSxLQUFnQjtRQUVuRSxNQUFNLGdCQUFnQixHQUFHLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFOztZQUU3QyxNQUFNLElBQUksU0FBRyxTQUFTLENBQUMsUUFBUSxtQ0FBSSxTQUFTLENBQUMsRUFBRSxDQUFDO1lBRWhELElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUVoQyxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FB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O1FBRUgsT0FBTyxhQUFhLENBQUM7SUFDekIsQ0FBQzs7OztZQTVHSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7Ozt3Q0FHZ0IsUUFBUSxZQUFJLE1BQU0sU0FBQyxnQkFBZ0I7WUFwQnZCLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCwgRm9ybUdyb3VwIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgeyBEeW5hbWljRm9ybUNvbnRyb2xNb2RlbCB9IGZyb20gXCIuLi9tb2RlbC9keW5hbWljLWZvcm0tY29udHJvbC5tb2RlbFwiO1xuaW1wb3J0IHtcbiAgICBBTkRfT1BFUkFUT1IsXG4gICAgRFlOQU1JQ19NQVRDSEVSUyxcbiAgICBEeW5hbWljRm9ybUNvbnRyb2xNYXRjaGVyLFxuICAgIE9SX09QRVJBVE9SXG59IGZyb20gXCIuL2R5bmFtaWMtZm9ybS1yZWxhdGlvbi1tYXRjaGVyc1wiO1xuaW1wb3J0IHsgRHluYW1pY0Zvcm1Db250cm9sUmVsYXRpb24gfSBmcm9tIFwiLi4vbW9kZWwvbWlzYy9keW5hbWljLWZvcm0tY29udHJvbC1yZWxhdGlvbi5tb2RlbFwiO1xuaW1wb3J0IHsgc3RhcnRXaXRoIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBtZXJnZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSBcInJ4anNcIjtcblxuZXhwb3J0IHR5cGUgRHluYW1pY1JlbGF0ZWRGb3JtQ29udHJvbHMgPSB7IFtrZXk6IHN0cmluZ106IEZvcm1Db250cm9sIH07XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiBcInJvb3RcIlxufSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljRm9ybVJlbGF0aW9uU2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBASW5qZWN0KERZTkFNSUNfTUFUQ0hFUlMpIHByaXZhdGUgTUFUQ0hFUlM6IER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXJbXSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge1xuICAgIH1cblxuICAgIGdldFJlbGF0ZWRGb3JtQ29udHJvbHMobW9kZWw6IER5bmFtaWNGb3JtQ29udHJvbE1vZGVsLCBncm91cDogRm9ybUdyb3VwKTogRHluYW1pY1JlbGF0ZWRGb3JtQ29udHJvbHMge1xuXG4gICAgICAgIGNvbnN0IGNvbmRpdGlvblJlZHVjZXIgPSAoY29udHJvbHMsIGNvbmRpdGlvbikgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBwYXRoID0gY29uZGl0aW9uLnJvb3RQYXRoID8/IGNvbmRpdGlvbi5pZDtcblxuICAgICAgICAgICAgaWYgKCFjb250cm9scy5oYXNPd25Qcm9wZXJ0eShwYXRoKSkge1xuXG4gICAgICAgICAgICAgICAgY29uc3QgY29udHJvbCA9IGNvbmRpdGlvbi5yb290UGF0aCA/IGdyb3VwLnJvb3QuZ2V0KGNvbmRpdGlvbi5yb290UGF0aCkgOiBncm91cC5nZXQoY29uZGl0aW9uLmlkKTtcblxuICAgICAgICAgICAgICAgIGNvbnRyb2wgaW5zdGFuY2VvZiBGb3JtQ29udHJvbCA/IGNvbnRyb2xzW3BhdGhdID0gY29udHJvbCA6IGNvbnNvbGUud2FybihgTm8gcmVsYXRlZCBmb3JtIGNvbnRyb2wgd2l0aCBpZCAke2NvbmRpdGlvbi5pZH0gY291bGQgYmUgZm91bmRgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2xzO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlbGF0aW9uUmVkdWNlciA9IChjb250cm9scywgcmVsYXRpb24pID0+IHJlbGF0aW9uLndoZW4ucmVkdWNlKGNvbmRpdGlvblJlZHVjZXIsIGNvbnRyb2xzKTtcblxuICAgICAgICByZXR1cm4gbW9kZWwucmVsYXRpb25zLnJlZHVjZShyZWxhdGlvblJlZHVjZXIsIHt9KTtcbiAgICB9XG5cbiAgICBmaW5kUmVsYXRpb25CeU1hdGNoZXIocmVsYXRpb25zOiBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbltdLCBtYXRjaGVyOiBEeW5hbWljRm9ybUNvbnRyb2xNYXRjaGVyKTogRHluYW1pY0Zvcm1Db250cm9sUmVsYXRpb24gfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gcmVsYXRpb25zLmZpbmQocmVsYXRpb24gPT4gW21hdGNoZXIubWF0Y2gsIG1hdGNoZXIub3Bwb3NpbmdNYXRjaF0uaW5jbHVkZXMocmVsYXRpb24ubWF0Y2gpKTtcbiAgICB9XG5cbiAgICBtYXRjaGVzQ29uZGl0aW9uKHJlbGF0aW9uOiBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbiwgcmVsYXRlZEZvcm1Db250cm9sczogRHluYW1pY1JlbGF0ZWRGb3JtQ29udHJvbHMsIG1hdGNoZXI6IER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXIpOiBib29sZWFuIHtcblxuICAgICAgICBjb25zdCBvcGVyYXRvciA9IHJlbGF0aW9uLm9wZXJhdG9yID8/IE9SX09QRVJBVE9SO1xuXG4gICAgICAgIHJldHVybiByZWxhdGlvbi53aGVuLnJlZHVjZSgoaGFzQWxyZWFkeU1hdGNoZWQsIGNvbmRpdGlvbiwgaW5kZXgpID0+IHtcblxuICAgICAgICAgICAgY29uc3QgcGF0aCA9IGNvbmRpdGlvbi5yb290UGF0aCA/PyBjb25kaXRpb24uaWQ7XG5cbiAgICAgICAgICAgIGxldCByZWxhdGVkRm9ybUNvbnRyb2w7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgW2tleSwgY29udHJvbF0gb2YgT2JqZWN0LmVudHJpZXMocmVsYXRlZEZvcm1Db250cm9scykpIHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSBwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlbGF0ZWRGb3JtQ29udHJvbCA9IGNvbnRyb2w7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJlbGF0ZWRGb3JtQ29udHJvbCAmJiByZWxhdGlvbi5tYXRjaCA9PT0gbWF0Y2hlci5tYXRjaCkge1xuXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCAmJiBvcGVyYXRvciA9PT0gQU5EX09QRVJBVE9SICYmICFoYXNBbHJlYWR5TWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCAmJiBvcGVyYXRvciA9PT0gT1JfT1BFUkFUT1IgJiYgaGFzQWxyZWFkeU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbmRpdGlvbi52YWx1ZSA9PT0gcmVsYXRlZEZvcm1Db250cm9sLnZhbHVlIHx8IGNvbmRpdGlvbi5zdGF0dXMgPT09IHJlbGF0ZWRGb3JtQ29udHJvbC5zdGF0dXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWxhdGVkRm9ybUNvbnRyb2wgJiYgcmVsYXRpb24ubWF0Y2ggPT09IG1hdGNoZXIub3Bwb3NpbmdNYXRjaCkge1xuXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCAmJiBvcGVyYXRvciA9PT0gQU5EX09QRVJBVE9SICYmIGhhc0FscmVhZHlNYXRjaGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDAgJiYgb3BlcmF0b3IgPT09IE9SX09QRVJBVE9SICYmICFoYXNBbHJlYWR5TWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuICEoY29uZGl0aW9uLnZhbHVlID09PSByZWxhdGVkRm9ybUNvbnRyb2wudmFsdWUgfHwgY29uZGl0aW9uLnN0YXR1cyA9PT0gcmVsYXRlZEZvcm1Db250cm9sLnN0YXR1cyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICB9LCBmYWxzZSk7XG4gICAgfVxuXG4gICAgc3Vic2NyaWJlUmVsYXRpb25zKG1vZGVsOiBEeW5hbWljRm9ybUNvbnRyb2xNb2RlbCwgZ3JvdXA6IEZvcm1Hcm91cCwgY29udHJvbDogRm9ybUNvbnRyb2wpOiBTdWJzY3JpcHRpb25bXSB7XG5cbiAgICAgICAgY29uc3QgcmVsYXRlZEZvcm1Db250cm9scyA9IHRoaXMuZ2V0UmVsYXRlZEZvcm1Db250cm9scyhtb2RlbCwgZ3JvdXApO1xuICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gICAgICAgIE9iamVjdC52YWx1ZXMocmVsYXRlZEZvcm1Db250cm9scykuZm9yRWFjaChyZWxhdGVkQ29udHJvbCA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IHZhbHVlQ2hhbmdlcyA9IHJlbGF0ZWRDb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKHN0YXJ0V2l0aChyZWxhdGVkQ29udHJvbC52YWx1ZSkpO1xuICAgICAgICAgICAgY29uc3Qgc3RhdHVzQ2hhbmdlcyA9IHJlbGF0ZWRDb250cm9sLnN0YXR1c0NoYW5nZXMucGlwZShzdGFydFdpdGgocmVsYXRlZENvbnRyb2wuc3RhdHVzKSk7XG5cbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnMucHVzaChtZXJnZSh2YWx1ZUNoYW5nZXMsIHN0YXR1c0NoYW5nZXMpLnN1YnNjcmliZSgoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLk1BVENIRVJTLmZvckVhY2gobWF0Y2hlciA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVsYXRpb24gPSB0aGlzLmZpbmRSZWxhdGlvbkJ5TWF0Y2hlcihtb2RlbC5yZWxhdGlvbnMsIG1hdGNoZXIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZWxhdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhc01hdGNoID0gdGhpcy5tYXRjaGVzQ29uZGl0aW9uKHJlbGF0aW9uLCByZWxhdGVkRm9ybUNvbnRyb2xzLCBtYXRjaGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXIub25DaGFuZ2UoaGFzTWF0Y2gsIG1vZGVsLCBjb250cm9sLCB0aGlzLmluamVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9ucztcbiAgICB9XG59XG4iXX0=