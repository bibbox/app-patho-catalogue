/* ngx-moment (c) 2015, 2016 Uri Shaked / MIT Licence */
import { Pipe, ChangeDetectorRef, NgZone } from '@angular/core';
import * as moment from 'moment';
import * as ɵngcc0 from '@angular/core';
const momentConstructor = moment;
export class TimeAgoPipe {
    constructor(cdRef, ngZone) {
        this.cdRef = cdRef;
        this.ngZone = ngZone;
    }
    format(m) {
        return m.from(momentConstructor(), this.lastOmitSuffix);
    }
    transform(value, omitSuffix, formatFn) {
        if (this.hasChanged(value, omitSuffix)) {
            this.lastTime = this.getTime(value);
            this.lastValue = value;
            this.lastOmitSuffix = omitSuffix;
            this.lastLocale = this.getLocale(value);
            this.formatFn = formatFn || this.format.bind(this);
            this.removeTimer();
            this.createTimer();
            this.lastText = this.formatFn(momentConstructor(value));
        }
        else {
            this.createTimer();
        }
        return this.lastText;
    }
    ngOnDestroy() {
        this.removeTimer();
    }
    createTimer() {
        if (this.currentTimer) {
            return;
        }
        const momentInstance = momentConstructor(this.lastValue);
        const timeToUpdate = this.getSecondsUntilUpdate(momentInstance) * 1000;
        this.currentTimer = this.ngZone.runOutsideAngular(() => {
            if (typeof window !== 'undefined') {
                return window.setTimeout(() => {
                    this.lastText = this.formatFn(momentConstructor(this.lastValue));
                    this.currentTimer = null;
                    this.ngZone.run(() => this.cdRef.markForCheck());
                }, timeToUpdate);
            }
            else {
                return null;
            }
        });
    }
    removeTimer() {
        if (this.currentTimer) {
            window.clearTimeout(this.currentTimer);
            this.currentTimer = null;
        }
    }
    getSecondsUntilUpdate(momentInstance) {
        const howOld = Math.abs(momentConstructor().diff(momentInstance, 'minute'));
        if (howOld < 1) {
            return 1;
        }
        else if (howOld < 60) {
            return 30;
        }
        else if (howOld < 180) {
            return 300;
        }
        else {
            return 3600;
        }
    }
    hasChanged(value, omitSuffix) {
        return (this.getTime(value) !== this.lastTime ||
            this.getLocale(value) !== this.lastLocale ||
            omitSuffix !== this.lastOmitSuffix);
    }
    getTime(value) {
        if (moment.isDate(value)) {
            return value.getTime();
        }
        else if (moment.isMoment(value)) {
            return value.valueOf();
        }
        else {
            return momentConstructor(value).valueOf();
        }
    }
    getLocale(value) {
        return moment.isMoment(value) ? value.locale() : moment.locale();
    }
}
TimeAgoPipe.ɵfac = function TimeAgoPipe_Factory(t) { return new (t || TimeAgoPipe)(ɵngcc0.ɵɵinjectPipeChangeDetectorRef(), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone)); };
TimeAgoPipe.ɵpipe = ɵngcc0.ɵɵdefinePipe({ name: "amTimeAgo", type: TimeAgoPipe, pure: false });
TimeAgoPipe.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: NgZone }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(TimeAgoPipe, [{
        type: Pipe,
        args: [{ name: 'amTimeAgo', pure: false }]
    }], function () { return [{ type: ɵngcc0.ChangeDetectorRef }, { type: ɵngcc0.NgZone }]; }, null); })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1hZ28ucGlwZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3RpbWUtYWdvLnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLE9BQU8sRUFBRSxJQUFJLEVBQUUsaUJBQWlCLEVBQTRCLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRixPQUFPLEtBQUssTUFBTSxNQUFNLFFBQVEsQ0FBQyxqQ0FBakMsT0FBTyxLQUFLLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFFakMsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUMsQ0FHakMsTUFBTTtNQUFPLFdBQVcsT0FVdEIseEJBYkYsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLENBQUM7RUFhWCxLQUF3QixFQUFVLE1BQWMsZkFWdEUsTUFBTSxPQUFPLFdBQVc7QUFVRixVQUFLLEdBQUwsS0FBSyxDQUFtQixTQUFVLDVCQVY3QixJQVV6QixZQUFvQixLQUF3QixFQUFVLE1BQWM7TUFBUixHQUFOLE1BQU0sQ0FBUSxLQUFHLENBQUMsS0FFeEUsM0JBRndFLFFBQXBELFVBQUssR0FBTCxLQUFLLENBQW1CO0tBRXRDLENBQUMsQ0FBZ0IsWUFDckIsT0FBTyxDQUFDLENBQUMsNUJBSGtDLFFBQVMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtFQUdyRCxDQUFDLEhBSHFELElBQUUsQ0FBQztjQUd2QyxkQUZuQyxJQUNFLE1BQU0sQ0FBQyxDQUFnQjtBQUNZLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEtBQzFELENBQUMsS0FFRCxTQUFTLENBQ1AsS0FBeUIsRUFDekIsVUFBb0IsRUFDcEIsL0RBTkosUUFBSSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDNUQsSUFBRSxDQUFDO0FBS3dDLFlBRXZDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsdkNBTi9CLElBQ0UsU0FBUyxDQUNQLEtBQXlCLEVB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OlsiLyogbmd4LW1vbWVudCAoYykgMjAxNSwgMjAxNiBVcmkgU2hha2VkIC8gTUlUIExpY2VuY2UgKi9cblxuaW1wb3J0IHsgUGlwZSwgQ2hhbmdlRGV0ZWN0b3JSZWYsIFBpcGVUcmFuc2Zvcm0sIE9uRGVzdHJveSwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50JztcblxuY29uc3QgbW9tZW50Q29uc3RydWN0b3IgPSBtb21lbnQ7XG5cbkBQaXBlKHsgbmFtZTogJ2FtVGltZUFnbycsIHB1cmU6IGZhbHNlIH0pXG5leHBvcnQgY2xhc3MgVGltZUFnb1BpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtLCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGN1cnJlbnRUaW1lcjogbnVtYmVyIHwgbnVsbDtcblxuICBwcml2YXRlIGxhc3RUaW1lOiBOdW1iZXI7XG4gIHByaXZhdGUgbGFzdFZhbHVlOiBtb21lbnQuTW9tZW50SW5wdXQ7XG4gIHByaXZhdGUgbGFzdE9taXRTdWZmaXg6IGJvb2xlYW47XG4gIHByaXZhdGUgbGFzdExvY2FsZT86IHN0cmluZztcbiAgcHJpdmF0ZSBsYXN0VGV4dDogc3RyaW5nO1xuICBwcml2YXRlIGZvcm1hdEZuOiAobTogbW9tZW50Lk1vbWVudCkgPT4gc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2RSZWY6IENoYW5nZURldGVjdG9yUmVmLCBwcml2YXRlIG5nWm9uZTogTmdab25lKSB7fVxuXG4gIGZvcm1hdChtOiBtb21lbnQuTW9tZW50KSB7XG4gICAgcmV0dXJuIG0uZnJvbShtb21lbnRDb25zdHJ1Y3RvcigpLCB0aGlzLmxhc3RPbWl0U3VmZml4KTtcbiAgfVxuXG4gIHRyYW5zZm9ybShcbiAgICB2YWx1ZTogbW9tZW50Lk1vbWVudElucHV0LFxuICAgIG9taXRTdWZmaXg/OiBib29sZWFuLFxuICAgIGZvcm1hdEZuPzogKG06IG1vbWVudC5Nb21lbnQpID0+IHN0cmluZyxcbiAgKTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5oYXNDaGFuZ2VkKHZhbHVlLCBvbWl0U3VmZml4KSkge1xuICAgICAgdGhpcy5sYXN0VGltZSA9IHRoaXMuZ2V0VGltZSh2YWx1ZSk7XG4gICAgICB0aGlzLmxhc3RWYWx1ZSA9IHZhbHVlO1xuICAgICAgdGhpcy5sYXN0T21pdFN1ZmZpeCA9IG9taXRTdWZmaXg7XG4gICAgICB0aGlzLmxhc3RMb2NhbGUgPSB0aGlzLmdldExvY2FsZSh2YWx1ZSk7XG4gICAgICB0aGlzLmZvcm1hdEZuID0gZm9ybWF0Rm4gfHwgdGhpcy5mb3JtYXQuYmluZCh0aGlzKTtcbiAgICAgIHRoaXMucmVtb3ZlVGltZXIoKTtcbiAgICAgIHRoaXMuY3JlYXRlVGltZXIoKTtcbiAgICAgIHRoaXMubGFzdFRleHQgPSB0aGlzLmZvcm1hdEZuKG1vbWVudENvbnN0cnVjdG9yKHZhbHVlKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3JlYXRlVGltZXIoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5sYXN0VGV4dDtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMucmVtb3ZlVGltZXIoKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVGltZXIoKSB7XG4gICAgaWYgKHRoaXMuY3VycmVudFRpbWVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbW9tZW50SW5zdGFuY2UgPSBtb21lbnRDb25zdHJ1Y3Rvcih0aGlzLmxhc3RWYWx1ZSk7XG4gICAgY29uc3QgdGltZVRvVXBkYXRlID0gdGhpcy5nZXRTZWNvbmRzVW50aWxVcGRhdGUobW9tZW50SW5zdGFuY2UpICogMTAwMDtcblxuICAgIHRoaXMuY3VycmVudFRpbWVyID0gdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIHJldHVybiB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5sYXN0VGV4dCA9IHRoaXMuZm9ybWF0Rm4obW9tZW50Q29uc3RydWN0b3IodGhpcy5sYXN0VmFsdWUpKTtcblxuICAgICAgICAgIHRoaXMuY3VycmVudFRpbWVyID0gbnVsbDtcbiAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4gdGhpcy5jZFJlZi5tYXJrRm9yQ2hlY2soKSk7XG4gICAgICAgIH0sIHRpbWVUb1VwZGF0ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlVGltZXIoKSB7XG4gICAgaWYgKHRoaXMuY3VycmVudFRpbWVyKSB7XG4gICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuY3VycmVudFRpbWVyKTtcbiAgICAgIHRoaXMuY3VycmVudFRpbWVyID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFNlY29uZHNVbnRpbFVwZGF0ZShtb21lbnRJbnN0YW5jZTogbW9tZW50Lk1vbWVudCkge1xuICAgIGNvbnN0IGhvd09sZCA9IE1hdGguYWJzKG1vbWVudENvbnN0cnVjdG9yKCkuZGlmZihtb21lbnRJbnN0YW5jZSwgJ21pbnV0ZScpKTtcbiAgICBpZiAoaG93T2xkIDwgMSkge1xuICAgICAgcmV0dXJuIDE7XG4gICAgfSBlbHNlIGlmIChob3dPbGQgPCA2MCkge1xuICAgICAgcmV0dXJuIDMwO1xuICAgIH0gZWxzZSBpZiAoaG93T2xkIDwgMTgwKSB7XG4gICAgICByZXR1cm4gMzAwO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gMzYwMDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhc0NoYW5nZWQodmFsdWU6IG1vbWVudC5Nb21lbnRJbnB1dCwgb21pdFN1ZmZpeD86IGJvb2xlYW4pOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5nZXRUaW1lKHZhbHVlKSAhPT0gdGhpcy5sYXN0VGltZSB8fFxuICAgICAgdGhpcy5nZXRMb2NhbGUodmFsdWUpICE9PSB0aGlzLmxhc3RMb2NhbGUgfHxcbiAgICAgIG9taXRTdWZmaXggIT09IHRoaXMubGFzdE9taXRTdWZmaXhcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUaW1lKHZhbHVlOiBtb21lbnQuTW9tZW50SW5wdXQpOiBudW1iZXIge1xuICAgIGlmIChtb21lbnQuaXNEYXRlKHZhbHVlKSkge1xuICAgICAgcmV0dXJuIHZhbHVlLmdldFRpbWUoKTtcbiAgICB9IGVsc2UgaWYgKG1vbWVudC5pc01vbWVudCh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiB2YWx1ZS52YWx1ZU9mKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBtb21lbnRDb25zdHJ1Y3Rvcih2YWx1ZSkudmFsdWVPZigpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0TG9jYWxlKHZhbHVlOiBtb21lbnQuTW9tZW50SW5wdXQpOiBzdHJpbmcgfCBudWxsIHtcbiAgICByZXR1cm4gbW9tZW50LmlzTW9tZW50KHZhbHVlKSA/IHZhbHVlLmxvY2FsZSgpIDogbW9tZW50LmxvY2FsZSgpO1xuICB9XG59XG4iXX0=