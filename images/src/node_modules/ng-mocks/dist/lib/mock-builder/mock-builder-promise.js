"use strict";
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spread = (this && this.__spread) || function () {
    for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat(__read(arguments[i]));
    return ar;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MockBuilderPromise = void 0;
var testing_1 = require("@angular/core/testing");
var core_helpers_1 = require("../common/core.helpers");
var core_reflect_1 = require("../common/core.reflect");
var core_tokens_1 = require("../common/core.tokens");
var func_is_ng_def_1 = require("../common/func.is-ng-def");
var func_is_ng_injection_token_1 = require("../common/func.is-ng-injection-token");
var func_is_ng_module_def_with_providers_1 = require("../common/func.is-ng-module-def-with-providers");
var ng_mocks_universe_1 = require("../common/ng-mocks-universe");
var mock_component_1 = require("../mock-component/mock-component");
var mock_directive_1 = require("../mock-directive/mock-directive");
var mock_helper_1 = require("../mock-helper/mock-helper");
var mock_module_1 = require("../mock-module/mock-module");
var mock_pipe_1 = require("../mock-pipe/mock-pipe");
var helper_1 = require("../mock-service/helper");
var mock_provider_1 = require("../mock-service/mock-provider");
var mock_service_1 = require("../mock-service/mock-service");
var mock_builder_promise_extract_dep_1 = require("./mock-builder-promise.extract-dep");
var mock_builder_promise_skip_dep_1 = require("./mock-builder-promise.skip-dep");
var defaultMock = {}; // simulating Symbol
var MockBuilderPromise = /** @class */ (function () {
    function MockBuilderPromise() {
        this.beforeCC = new Set();
        this.configDef = new Map();
        this.defProviders = new Map();
        this.defValue = new Map();
        this.excludeDef = new Set();
        this.keepDef = new Set();
        this.mockDef = new Set();
        this.providerDef = new Map();
        this.replaceDef = new Set();
    }
    MockBuilderPromise.prototype.beforeCompileComponents = function (callback) {
        this.beforeCC.add(callback);
        return this;
    };
    MockBuilderPromise.prototype.build = function () {
        var e_1, _a, e_2, _b, e_3, _c, e_4, _d, e_5, _e, e_6, _f, e_7, _g, e_8, _h, e_9, _j, e_10, _k, e_11, _l, e_12, _m, e_13, _o, e_14, _p, e_15, _q, e_16, _r, e_17, _s, e_18, _t;
        var backup = {
            builtDeclarations: ng_mocks_universe_1.default.builtDeclarations,
            builtProviders: ng_mocks_universe_1.default.builtProviders,
            cacheDeclarations: ng_mocks_universe_1.default.cacheDeclarations,
            cacheProviders: ng_mocks_universe_1.default.cacheProviders,
            config: ng_mocks_universe_1.default.config,
            flags: ng_mocks_universe_1.default.flags,
            touches: ng_mocks_universe_1.default.touches,
        };
        ng_mocks_universe_1.default.builtDeclarations = new Map();
        ng_mocks_universe_1.default.builtProviders = new Map();
        ng_mocks_universe_1.default.cacheDeclarations = new Map();
        ng_mocks_universe_1.default.cacheProviders = new Map();
        ng_mocks_universe_1.default.config = new Map();
        ng_mocks_universe_1.default.flags = new Set([
            'cacheComponent',
            'cacheDirective',
            'cacheModule',
            'cachePipe',
            'cacheProvider',
            'correctModuleExports',
        ]);
        ng_mocks_universe_1.default.touches = new Set();
        ng_mocks_universe_1.default.config.set('multi', new Set()); // collecting multi flags of providers.
        ng_mocks_universe_1.default.config.set('deps', new Set()); // collecting all deps of providers.
        ng_mocks_universe_1.default.config.set('depsSkip', new Set()); // collecting all declarations of kept modules.
        ng_mocks_universe_1.default.config.set('resolution', new Map()); // flags to understand how to mock nested declarations.
        try {
            for (var _u = __values(core_helpers_1.mapEntries(this.configDef)), _v = _u.next(); !_v.done; _v = _u.next()) {
                var _w = __read(_v.value, 2), k = _w[0], v = _w[1];
                ng_mocks_universe_1.default.config.set(k, v);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_v && !_v.done && (_a = _u.return)) _a.call(_u);
            }
            finally { if (e_1) throw e_1.error; }
        }
        try {
            for (var _x = __values(core_helpers_1.mapValues(this.keepDef)), _y = _x.next(); !_y.done; _y = _x.next()) {
                var def = _y.value;
                ng_mocks_universe_1.default.builtDeclarations.set(def, def);
                ng_mocks_universe_1.default.builtProviders.set(def, def);
                ng_mocks_universe_1.default.config.get('resolution').set(def, 'keep');
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_y && !_y.done && (_b = _x.return)) _b.call(_x);
            }
            finally { if (e_2) throw e_2.error; }
        }
        try {
            for (var _z = __values(core_helpers_1.mapValues(this.replaceDef)), _0 = _z.next(); !_0.done; _0 = _z.next()) {
                var def = _0.value;
                ng_mocks_universe_1.default.builtDeclarations.set(def, this.defValue.get(def));
                ng_mocks_universe_1.default.config.get('resolution').set(def, 'replace');
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_0 && !_0.done && (_c = _z.return)) _c.call(_z);
            }
            finally { if (e_3) throw e_3.error; }
        }
        try {
            for (var _1 = __values(__spread(core_helpers_1.mapValues(this.excludeDef))), _2 = _1.next(); !_2.done; _2 = _1.next()) {
                var def = _2.value;
                ng_mocks_universe_1.default.builtDeclarations.set(def, null);
                ng_mocks_universe_1.default.builtProviders.set(def, null);
                ng_mocks_universe_1.default.config.get('resolution').set(def, 'exclude');
            }
        }
        catch (e_4_1) { e_4 = { error: e_4_1 }; }
        finally {
            try {
                if (_2 && !_2.done && (_d = _1.return)) _d.call(_1);
            }
            finally { if (e_4) throw e_4.error; }
        }
        var _loop_1 = function (def) {
            ng_mocks_universe_1.default.config.get('resolution').set(def, 'mock');
            if (func_is_ng_def_1.isNgDef(def, 'c')) {
                ng_mocks_universe_1.default.builtDeclarations.set(def, mock_component_1.MockComponent(def));
            }
            if (func_is_ng_def_1.isNgDef(def, 'd')) {
                ng_mocks_universe_1.default.builtDeclarations.set(def, mock_directive_1.MockDirective(def));
            }
            if (func_is_ng_def_1.isNgDef(def, 'p')) {
                var instance = this_1.defValue.get(def);
                ng_mocks_universe_1.default.builtDeclarations.set(def, typeof instance === 'function'
                    ? mock_pipe_1.MockPipe(def, instance)
                    : instance && typeof instance === 'object' && typeof instance.transform === 'function'
                        ? mock_pipe_1.MockPipe(def, instance.transform)
                        : mock_pipe_1.MockPipe(def));
            }
            if (func_is_ng_def_1.isNgDef(def, 'i') && this_1.defValue.has(def)) {
                var instance_1 = this_1.defValue.get(def);
                var isFunc_1 = func_is_ng_def_1.isNgDef(def, 'p') && typeof instance_1 === 'function';
                ng_mocks_universe_1.default.builtProviders.set(def, helper_1.default.useFactory(def, function () {
                    return isFunc_1 ? mock_helper_1.ngMocks.stub(mock_service_1.MockService(def), { transform: instance_1 }) : instance_1;
                }));
            }
            else if (func_is_ng_def_1.isNgDef(def, 'i')) {
                ng_mocks_universe_1.default.builtProviders.set(def, mock_provider_1.default(def));
            }
            if (!func_is_ng_def_1.isNgDef(def) && this_1.defValue.has(def)) {
                var instance_2 = this_1.defValue.get(def);
                ng_mocks_universe_1.default.builtProviders.set(def, helper_1.default.useFactory(def, function () { return instance_2; }));
            }
            else if (!func_is_ng_def_1.isNgDef(def)) {
                ng_mocks_universe_1.default.builtProviders.set(def, mock_provider_1.default(def));
            }
            ng_mocks_universe_1.default.touches.delete(def);
        };
        var this_1 = this;
        try {
            // Mocking requested things.
            for (var _3 = __values(core_helpers_1.mapValues(this.mockDef)), _4 = _3.next(); !_4.done; _4 = _3.next()) {
                var def = _4.value;
                _loop_1(def);
            }
        }
        catch (e_5_1) { e_5 = { error: e_5_1 }; }
        finally {
            try {
                if (_4 && !_4.done && (_e = _3.return)) _e.call(_3);
            }
            finally { if (e_5) throw e_5.error; }
        }
        // Now we need to run through requested modules.
        var defProviders = new Map();
        try {
            for (var _5 = __values(__spread(core_helpers_1.mapValues(this.keepDef), core_helpers_1.mapValues(this.mockDef), core_helpers_1.mapValues(this.replaceDef))), _6 = _5.next(); !_6.done; _6 = _5.next()) {
                var def = _6.value;
                if (!func_is_ng_def_1.isNgDef(def, 'm')) {
                    continue;
                }
                if (this.defProviders.has(def) && this.mockDef.has(def)) {
                    var _7 = __read(mock_module_1.MockNgDef({ providers: this.defProviders.get(def) }), 2), loDef = _7[1];
                    defProviders.set(def, loDef.providers);
                }
                else if (this.defProviders.has(def)) {
                    defProviders.set(def, this.defProviders.get(def));
                }
                ng_mocks_universe_1.default.builtDeclarations.set(def, mock_module_1.MockModule(def));
                ng_mocks_universe_1.default.touches.delete(def);
            }
        }
        catch (e_6_1) { e_6 = { error: e_6_1 }; }
        finally {
            try {
                if (_6 && !_6.done && (_f = _5.return)) _f.call(_5);
            }
            finally { if (e_6) throw e_6.error; }
        }
        // Setting up TestBed.
        var imports = [];
        var declarations = [];
        var providers = [];
        try {
            // Adding suitable leftovers.
            for (var _8 = __values(__spread(core_helpers_1.mapValues(this.mockDef), core_helpers_1.mapValues(this.keepDef), core_helpers_1.mapValues(this.replaceDef))), _9 = _8.next(); !_9.done; _9 = _8.next()) {
                var def = _9.value;
                if (func_is_ng_def_1.isNgDef(def, 'i') || !func_is_ng_def_1.isNgDef(def)) {
                    continue;
                }
                if (ng_mocks_universe_1.default.touches.has(def)) {
                    continue;
                }
                var config = this.configDef.get(def);
                if (config && config.dependency) {
                    continue;
                }
                if (func_is_ng_def_1.isNgDef(def, 'm')) {
                    var loModule = ng_mocks_universe_1.default.builtDeclarations.get(def);
                    var loProviders = defProviders.has(def) ? defProviders.get(def) : undefined;
                    imports.push(loProviders
                        ? {
                            ngModule: loModule,
                            providers: loProviders,
                        }
                        : loModule);
                }
                else {
                    declarations.push(ng_mocks_universe_1.default.builtDeclarations.get(def));
                }
                ng_mocks_universe_1.default.touches.add(def);
            }
        }
        catch (e_7_1) { e_7 = { error: e_7_1 }; }
        finally {
            try {
                if (_9 && !_9.done && (_g = _8.return)) _g.call(_8);
            }
            finally { if (e_7) throw e_7.error; }
        }
        try {
            // Adding missed kept providers to test bed.
            for (var _10 = __values(core_helpers_1.mapValues(this.keepDef)), _11 = _10.next(); !_11.done; _11 = _10.next()) {
                var def = _11.value;
                if (!func_is_ng_def_1.isNgDef(def, 'i') && func_is_ng_def_1.isNgDef(def)) {
                    continue;
                }
                if (ng_mocks_universe_1.default.touches.has(def)) {
                    continue;
                }
                var config = this.configDef.get(def);
                if (config && config.dependency) {
                    continue;
                }
                if (func_is_ng_injection_token_1.isNgInjectionToken(def)) {
                    ng_mocks_universe_1.default.touches.add(def);
                    continue;
                }
                providers.push(def);
                ng_mocks_universe_1.default.touches.add(def);
            }
        }
        catch (e_8_1) { e_8 = { error: e_8_1 }; }
        finally {
            try {
                if (_11 && !_11.done && (_h = _10.return)) _h.call(_10);
            }
            finally { if (e_8) throw e_8.error; }
        }
        try {
            // Adding missed mock providers to test bed.
            for (var _12 = __values(core_helpers_1.mapValues(this.mockDef)), _13 = _12.next(); !_13.done; _13 = _12.next()) {
                var def = _13.value;
                if (!func_is_ng_def_1.isNgDef(def, 'i') && func_is_ng_def_1.isNgDef(def)) {
                    continue;
                }
                if (ng_mocks_universe_1.default.touches.has(def)) {
                    continue;
                }
                var config = this.configDef.get(def);
                if (config && config.dependency) {
                    continue;
                }
                var mock = ng_mocks_universe_1.default.builtProviders.get(def);
                providers.push(mock || { provide: def, useValue: undefined });
                ng_mocks_universe_1.default.touches.add(def);
            }
        }
        catch (e_9_1) { e_9 = { error: e_9_1 }; }
        finally {
            try {
                if (_13 && !_13.done && (_j = _12.return)) _j.call(_12);
            }
            finally { if (e_9) throw e_9.error; }
        }
        try {
            // Adding requested providers to test bed.
            for (var _14 = __values(core_helpers_1.mapValues(this.providerDef)), _15 = _14.next(); !_15.done; _15 = _14.next()) {
                var provider = _15.value;
                providers.push(provider);
            }
        }
        catch (e_10_1) { e_10 = { error: e_10_1 }; }
        finally {
            try {
                if (_15 && !_15.done && (_k = _14.return)) _k.call(_14);
            }
            finally { if (e_10) throw e_10.error; }
        }
        try {
            // Analyzing providers.
            for (var _16 = __values(core_helpers_1.flatten(providers)), _17 = _16.next(); !_17.done; _17 = _16.next()) {
                var provider = _17.value;
                var provide = typeof provider === 'object' && provider.provide ? provider.provide : provider;
                ng_mocks_universe_1.default.touches.add(provide);
                if (provide !== provider && provider.deps) {
                    core_helpers_1.extractDependency(provider.deps, ng_mocks_universe_1.default.config.get('deps'));
                }
            }
        }
        catch (e_11_1) { e_11 = { error: e_11_1 }; }
        finally {
            try {
                if (_17 && !_17.done && (_l = _16.return)) _l.call(_16);
            }
            finally { if (e_11) throw e_11.error; }
        }
        // Mocking root providers.
        var parameters = new Set();
        if (!this.keepDef.has(core_tokens_1.NG_MOCKS_ROOT_PROVIDERS)) {
            // We need buckets here to process first all depsSkip, then deps and only after that all other defs.
            var buckets = [];
            buckets.push(core_helpers_1.mapValues(ng_mocks_universe_1.default.config.get('depsSkip')));
            buckets.push(core_helpers_1.mapValues(ng_mocks_universe_1.default.config.get('deps')));
            buckets.push(core_helpers_1.mapValues(ng_mocks_universe_1.default.touches));
            // Also we need to track what has been touched to check params recursively, but avoiding duplicates.
            var touched = [].concat.apply([], __spread(buckets));
            try {
                for (var buckets_1 = __values(buckets), buckets_1_1 = buckets_1.next(); !buckets_1_1.done; buckets_1_1 = buckets_1.next()) {
                    var bucket = buckets_1_1.value;
                    try {
                        for (var bucket_1 = (e_13 = void 0, __values(bucket)), bucket_1_1 = bucket_1.next(); !bucket_1_1.done; bucket_1_1 = bucket_1.next()) {
                            var def = bucket_1_1.value;
                            if (!mock_builder_promise_skip_dep_1.default(def)) {
                                if (this.mockDef.has(core_tokens_1.NG_MOCKS_ROOT_PROVIDERS) || !ng_mocks_universe_1.default.config.get('depsSkip').has(def)) {
                                    parameters.add(def);
                                }
                            }
                            try {
                                for (var _18 = (e_14 = void 0, __values(core_reflect_1.jitReflector.parameters(def))), _19 = _18.next(); !_19.done; _19 = _18.next()) {
                                    var decorators = _19.value;
                                    var provide = mock_builder_promise_extract_dep_1.default(decorators);
                                    if (mock_builder_promise_skip_dep_1.default(provide)) {
                                        continue;
                                    }
                                    if (ng_mocks_universe_1.default.config.get('depsSkip').has(provide)) {
                                        continue;
                                    }
                                    if (typeof provide === 'function' && touched.indexOf(provide) === -1) {
                                        touched.push(provide);
                                        bucket.push(provide);
                                    }
                                    if (this.mockDef.has(core_tokens_1.NG_MOCKS_ROOT_PROVIDERS) || !ng_mocks_universe_1.default.config.get('depsSkip').has(def)) {
                                        parameters.add(provide);
                                    }
                                    else {
                                        ng_mocks_universe_1.default.config.get('depsSkip').add(provide);
                                    }
                                }
                            }
                            catch (e_14_1) { e_14 = { error: e_14_1 }; }
                            finally {
                                try {
                                    if (_19 && !_19.done && (_p = _18.return)) _p.call(_18);
                                }
                                finally { if (e_14) throw e_14.error; }
                            }
                        }
                    }
                    catch (e_13_1) { e_13 = { error: e_13_1 }; }
                    finally {
                        try {
                            if (bucket_1_1 && !bucket_1_1.done && (_o = bucket_1.return)) _o.call(bucket_1);
                        }
                        finally { if (e_13) throw e_13.error; }
                    }
                }
            }
            catch (e_12_1) { e_12 = { error: e_12_1 }; }
            finally {
                try {
                    if (buckets_1_1 && !buckets_1_1.done && (_m = buckets_1.return)) _m.call(buckets_1);
                }
                finally { if (e_12) throw e_12.error; }
            }
        }
        // Adding missed providers.
        if (parameters.size) {
            var parametersMap = new Map();
            var _loop_2 = function (parameter) {
                var mock = helper_1.default.resolveProvider(parameter, parametersMap);
                if (mock) {
                    providers.push(mock);
                }
                else if (func_is_ng_injection_token_1.isNgInjectionToken(parameter)) {
                    var multi_1 = ng_mocks_universe_1.default.config.has('multi') && ng_mocks_universe_1.default.config.get('multi').has(parameter);
                    providers.push(helper_1.default.useFactory(parameter, function () { return (multi_1 ? [] : undefined); }));
                }
            };
            try {
                for (var _20 = __values(core_helpers_1.mapValues(parameters)), _21 = _20.next(); !_21.done; _21 = _20.next()) {
                    var parameter = _21.value;
                    _loop_2(parameter);
                }
            }
            catch (e_15_1) { e_15 = { error: e_15_1 }; }
            finally {
                try {
                    if (_21 && !_21.done && (_q = _20.return)) _q.call(_20);
                }
                finally { if (e_15) throw e_15.error; }
            }
        }
        var mocks = new Map();
        try {
            for (var _22 = __values(__spread(core_helpers_1.mapEntries(ng_mocks_universe_1.default.builtProviders), core_helpers_1.mapEntries(ng_mocks_universe_1.default.builtDeclarations), core_helpers_1.mapEntries(ng_mocks_universe_1.default.cacheDeclarations), core_helpers_1.mapEntries(ng_mocks_universe_1.default.cacheProviders))), _23 = _22.next(); !_23.done; _23 = _22.next()) {
                var _24 = __read(_23.value, 2), key = _24[0], value = _24[1];
                if (mocks.has(key)) {
                    continue;
                }
                mocks.set(key, value);
            }
        }
        catch (e_16_1) { e_16 = { error: e_16_1 }; }
        finally {
            try {
                if (_23 && !_23.done && (_r = _22.return)) _r.call(_22);
            }
            finally { if (e_16) throw e_16.error; }
        }
        providers.push({
            provide: core_tokens_1.NG_MOCKS,
            useValue: mocks,
        });
        // Redefining providers for kept declarations.
        var touches = new Set();
        providers.push({
            provide: core_tokens_1.NG_MOCKS_TOUCHES,
            useValue: touches,
        });
        var overrides = new Map();
        providers.push({
            provide: core_tokens_1.NG_MOCKS_OVERRIDES,
            useValue: overrides,
        });
        try {
            for (var _25 = __values(core_helpers_1.mapValues(ng_mocks_universe_1.default.touches)), _26 = _25.next(); !_26.done; _26 = _25.next()) {
                var proto = _26.value;
                var source = proto;
                var value = ng_mocks_universe_1.default.builtDeclarations.get(source);
                // kept declarations should be based on their source.
                if (value === undefined) {
                    value = source;
                }
                touches.add(source);
                touches.add(value);
                // no reason to touch mocks
                if (ng_mocks_universe_1.default.cacheDeclarations.has(value)) {
                    continue;
                }
                // no customizations in replacements
                if (this.replaceDef.has(source) && value === this.defValue.get(source)) {
                    continue;
                }
                var meta = void 0;
                if (func_is_ng_def_1.isNgDef(value, 'c')) {
                    meta = core_reflect_1.directiveResolver.resolve(value);
                }
                else if (func_is_ng_def_1.isNgDef(value, 'd')) {
                    meta = core_reflect_1.directiveResolver.resolve(value);
                }
                else {
                    continue;
                }
                var skipMock = ng_mocks_universe_1.default.flags.has('skipMock');
                /* istanbul ignore else */
                if (!skipMock) {
                    ng_mocks_universe_1.default.flags.add('skipMock');
                }
                var _27 = __read(mock_module_1.MockNgDef({ providers: meta.providers }), 2), changed = _27[0], def = _27[1];
                /* istanbul ignore else */
                if (!skipMock) {
                    ng_mocks_universe_1.default.flags.delete('skipMock');
                }
                if (!changed) {
                    continue;
                }
                var override = {
                    set: def,
                };
                overrides.set(value, override);
            }
        }
        catch (e_17_1) { e_17 = { error: e_17_1 }; }
        finally {
            try {
                if (_26 && !_26.done && (_s = _25.return)) _s.call(_25);
            }
            finally { if (e_17) throw e_17.error; }
        }
        try {
            for (var _28 = __values(Object.keys(backup)), _29 = _28.next(); !_29.done; _29 = _28.next()) {
                var key = _29.value;
                ng_mocks_universe_1.default[key] = backup[key];
            }
        }
        catch (e_18_1) { e_18 = { error: e_18_1 }; }
        finally {
            try {
                if (_29 && !_29.done && (_t = _28.return)) _t.call(_28);
            }
            finally { if (e_18) throw e_18.error; }
        }
        return {
            declarations: declarations,
            imports: imports,
            providers: providers,
        };
    };
    MockBuilderPromise.prototype.exclude = function (def) {
        this.wipe(def);
        this.excludeDef.add(def);
        return this;
    };
    MockBuilderPromise.prototype.keep = function (input, config) {
        var _a = func_is_ng_module_def_with_providers_1.isNgModuleDefWithProviders(input)
            ? { def: input.ngModule, providers: input.providers }
            : { def: input, providers: undefined }, def = _a.def, providers = _a.providers;
        var existing = this.keepDef.has(def) ? this.defProviders.get(def) : [];
        this.wipe(def);
        this.keepDef.add(def);
        // a magic to support modules with providers.
        if (providers) {
            this.defProviders.set(def, __spread(existing, providers));
        }
        if (config) {
            this.configDef.set(def, config);
        }
        else {
            this.configDef.delete(def);
        }
        return this;
    };
    MockBuilderPromise.prototype.mock = function (input, a1, a2) {
        if (a1 === void 0) { a1 = defaultMock; }
        var _a = func_is_ng_module_def_with_providers_1.isNgModuleDefWithProviders(input)
            ? { def: input.ngModule, providers: input.providers }
            : { def: input, providers: undefined }, def = _a.def, providers = _a.providers;
        var mock = def === a1 ? defaultMock : a1;
        var config = a2 ? a2 : a1 !== defaultMock ? a1 : undefined;
        if (func_is_ng_def_1.isNgDef(def, 'p') && typeof a1 === 'function') {
            mock = a1;
            config = a2;
        }
        else if (func_is_ng_def_1.isNgDef(def, 'i') || !func_is_ng_def_1.isNgDef(def)) {
            config = a2;
        }
        mock = mock === config ? defaultMock : mock;
        var existing = this.mockDef.has(def) ? this.defProviders.get(def) : [];
        this.wipe(def);
        this.mockDef.add(def);
        // a magic to support modules with providers.
        if (providers) {
            this.defProviders.set(def, __spread(existing, providers));
        }
        if (mock !== defaultMock) {
            this.defValue.set(def, mock);
        }
        else {
            this.defValue.delete(def);
        }
        if (config) {
            this.configDef.set(def, config);
        }
        else {
            this.configDef.delete(def);
        }
        return this;
    };
    MockBuilderPromise.prototype.provide = function (def) {
        var e_19, _a;
        try {
            for (var _b = __values(core_helpers_1.flatten(def)), _c = _b.next(); !_c.done; _c = _b.next()) {
                var provider = _c.value;
                var provide = typeof provider === 'object' && provider.provide ? provider.provide : provider;
                var multi = typeof provider === 'object' && provider.provide && provider.multi;
                var existing = this.providerDef.has(provide) ? this.providerDef.get(provide) : [];
                this.wipe(provide);
                this.providerDef.set(provide, multi ? __spread(existing, [provider]) : provider);
            }
        }
        catch (e_19_1) { e_19 = { error: e_19_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_19) throw e_19.error; }
        }
        return this;
    };
    MockBuilderPromise.prototype.replace = function (source, destination, config) {
        if (!func_is_ng_def_1.isNgDef(destination) || !func_is_ng_def_1.isNgDef(source) || func_is_ng_def_1.isNgDef(destination, 'i') || func_is_ng_def_1.isNgDef(source, 'i')) {
            throw new Error('Cannot replace the declaration, both have to be a Module, a Component, a Directive or a Pipe, for Providers use `.mock` or `.provide`');
        }
        this.wipe(source);
        this.replaceDef.add(source);
        this.defValue.set(source, destination);
        if (config) {
            this.configDef.set(source, config);
        }
        else {
            this.configDef.delete(source);
        }
        return this;
    };
    MockBuilderPromise.prototype.then = function (fulfill, reject) {
        var _this = this;
        var promise = new Promise(function (resolve) {
            var e_20, _a;
            var testBed = testing_1.TestBed.configureTestingModule(_this.build());
            try {
                for (var _b = __values(core_helpers_1.mapValues(_this.beforeCC)), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var callback = _c.value;
                    callback(testBed);
                }
            }
            catch (e_20_1) { e_20 = { error: e_20_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_20) throw e_20.error; }
            }
            var testBedPromise = testBed.compileComponents();
            testBedPromise.then(function () {
                resolve({ testBed: testBed });
            });
        });
        return promise.then(fulfill, reject);
    };
    MockBuilderPromise.prototype.wipe = function (def) {
        this.defProviders.delete(def);
        this.defValue.delete(def);
        this.excludeDef.delete(def);
        this.keepDef.delete(def);
        this.mockDef.delete(def);
        this.providerDef.delete(def);
        this.replaceDef.delete(def);
    };
    return MockBuilderPromise;
}());
exports.MockBuilderPromise = MockBuilderPromise;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay1idWlsZGVyLXByb21pc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvbW9jay1idWlsZGVyL21vY2stYnVpbGRlci1wcm9taXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSxpREFBa0U7QUFFbEUsdURBQTJGO0FBQzNGLHVEQUF5RTtBQUN6RSxxREFBZ0g7QUFFaEgsMkRBQW1EO0FBQ25ELG1GQUEwRTtBQUMxRSx1R0FBbUg7QUFDbkgsaUVBQTBEO0FBQzFELG1FQUFpRTtBQUNqRSxtRUFBaUU7QUFDakUsMERBQXFEO0FBQ3JELDBEQUFtRTtBQUNuRSxvREFBa0Q7QUFDbEQsaURBQXVEO0FBQ3ZELCtEQUF5RDtBQUN6RCw2REFBMkQ7QUFFM0QsdUZBQTREO0FBQzVELGlGQUFzRDtBQUd0RCxJQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsQ0FBQyxvQkFBb0I7QUFFNUM7SUFBQTtRQUNZLGFBQVEsR0FBMkMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM3RCxjQUFTLEdBQThDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDakUsaUJBQVksR0FBcUQsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMzRSxhQUFRLEdBQThDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEUsZUFBVSxHQUF5QyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzdELFlBQU8sR0FBeUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMxRCxZQUFPLEdBQXlDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDMUQsZ0JBQVcsR0FBbUQsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUN4RSxlQUFVLEdBQXlDLElBQUksR0FBRyxFQUFFLENBQUM7SUF3ZXpFLENBQUM7SUF0ZVEsb0RBQXVCLEdBQTlCLFVBQStCLFFBQTJDO1FBQ3hFLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FB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Q0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVCLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFDSCx5QkFBQztBQUFELENBQUMsQUFqZkQsSUFpZkM7QUFqZlksZ0RBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0aW9uVG9rZW4sIE5nTW9kdWxlLCBQcm92aWRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTWV0YWRhdGFPdmVycmlkZSwgVGVzdEJlZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5cbmltcG9ydCB7IGV4dHJhY3REZXBlbmRlbmN5LCBmbGF0dGVuLCBtYXBFbnRyaWVzLCBtYXBWYWx1ZXMgfSBmcm9tICcuLi9jb21tb24vY29yZS5oZWxwZXJzJztcbmltcG9ydCB7IGRpcmVjdGl2ZVJlc29sdmVyLCBqaXRSZWZsZWN0b3IgfSBmcm9tICcuLi9jb21tb24vY29yZS5yZWZsZWN0JztcbmltcG9ydCB7IE5HX01PQ0tTLCBOR19NT0NLU19PVkVSUklERVMsIE5HX01PQ0tTX1JPT1RfUFJPVklERVJTLCBOR19NT0NLU19UT1VDSEVTIH0gZnJvbSAnLi4vY29tbW9uL2NvcmUudG9rZW5zJztcbmltcG9ydCB7IFR5cGUgfSBmcm9tICcuLi9jb21tb24vY29yZS50eXBlcyc7XG5pbXBvcnQgeyBpc05nRGVmIH0gZnJvbSAnLi4vY29tbW9uL2Z1bmMuaXMtbmctZGVmJztcbmltcG9ydCB7IGlzTmdJbmplY3Rpb25Ub2tlbiB9IGZyb20gJy4uL2NvbW1vbi9mdW5jLmlzLW5nLWluamVjdGlvbi10b2tlbic7XG5pbXBvcnQgeyBpc05nTW9kdWxlRGVmV2l0aFByb3ZpZGVycywgTmdNb2R1bGVXaXRoUHJvdmlkZXJzIH0gZnJvbSAnLi4vY29tbW9uL2Z1bmMuaXMtbmctbW9kdWxlLWRlZi13aXRoLXByb3ZpZGVycyc7XG5pbXBvcnQgbmdNb2Nrc1VuaXZlcnNlIGZyb20gJy4uL2NvbW1vbi9uZy1tb2Nrcy11bml2ZXJzZSc7XG5pbXBvcnQgeyBNb2NrQ29tcG9uZW50IH0gZnJvbSAnLi4vbW9jay1jb21wb25lbnQvbW9jay1jb21wb25lbnQnO1xuaW1wb3J0IHsgTW9ja0RpcmVjdGl2ZSB9IGZyb20gJy4uL21vY2stZGlyZWN0aXZlL21vY2stZGlyZWN0aXZlJztcbmltcG9ydCB7IG5nTW9ja3MgfSBmcm9tICcuLi9tb2NrLWhlbHBlci9tb2NrLWhlbHBlcic7XG5pbXBvcnQgeyBNb2NrTW9kdWxlLCBNb2NrTmdEZWYgfSBmcm9tICcuLi9tb2NrLW1vZHVsZS9tb2NrLW1vZHVsZSc7XG5pbXBvcnQgeyBNb2NrUGlwZSB9IGZyb20gJy4uL21vY2stcGlwZS9tb2NrLXBpcGUnO1xuaW1wb3J0IG1vY2tTZXJ2aWNlSGVscGVyIGZyb20gJy4uL21vY2stc2VydmljZS9oZWxwZXInO1xuaW1wb3J0IE1vY2tQcm92aWRlciBmcm9tICcuLi9tb2NrLXNlcnZpY2UvbW9jay1wcm92aWRlcic7XG5pbXBvcnQgeyBNb2NrU2VydmljZSB9IGZyb20gJy4uL21vY2stc2VydmljZS9tb2NrLXNlcnZpY2UnO1xuXG5pbXBvcnQgZXh0cmFjdERlcCBmcm9tICcuL21vY2stYnVpbGRlci1wcm9taXNlLmV4dHJhY3QtZGVwJztcbmltcG9ydCBza2lwRGVwIGZyb20gJy4vbW9jay1idWlsZGVyLXByb21pc2Uuc2tpcC1kZXAnO1xuaW1wb3J0IHsgSU1vY2tCdWlsZGVyLCBJTW9ja0J1aWxkZXJDb25maWcsIElNb2NrQnVpbGRlclJlc3VsdCB9IGZyb20gJy4vdHlwZXMnO1xuXG5jb25zdCBkZWZhdWx0TW9jayA9IHt9OyAvLyBzaW11bGF0aW5nIFN5bWJvbFxuXG5leHBvcnQgY2xhc3MgTW9ja0J1aWxkZXJQcm9taXNlIGltcGxlbWVudHMgUHJvbWlzZUxpa2U8SU1vY2tCdWlsZGVyUmVzdWx0PiwgSU1vY2tCdWlsZGVyIHtcbiAgcHJvdGVjdGVkIGJlZm9yZUNDOiBTZXQ8KHRlc3RCZWQ6IHR5cGVvZiBUZXN0QmVkKSA9PiB2b2lkPiA9IG5ldyBTZXQoKTtcbiAgcHJvdGVjdGVkIGNvbmZpZ0RlZjogTWFwPFR5cGU8YW55PiB8IEluamVjdGlvblRva2VuPGFueT4sIGFueT4gPSBuZXcgTWFwKCk7XG4gIHByb3RlY3RlZCBkZWZQcm92aWRlcnM6IE1hcDxUeXBlPGFueT4gfCBJbmplY3Rpb25Ub2tlbjxhbnk+LCBQcm92aWRlcltdPiA9IG5ldyBNYXAoKTtcbiAgcHJvdGVjdGVkIGRlZlZhbHVlOiBNYXA8VHlwZTxhbnk+IHwgSW5qZWN0aW9uVG9rZW48YW55PiwgYW55PiA9IG5ldyBNYXAoKTtcbiAgcHJvdGVjdGVkIGV4Y2x1ZGVEZWY6IFNldDxUeXBlPGFueT4gfCBJbmplY3Rpb25Ub2tlbjxhbnk+PiA9IG5ldyBTZXQoKTtcbiAgcHJvdGVjdGVkIGtlZXBEZWY6IFNldDxUeXBlPGFueT4gfCBJbmplY3Rpb25Ub2tlbjxhbnk+PiA9IG5ldyBTZXQoKTtcbiAgcHJvdGVjdGVkIG1vY2tEZWY6IFNldDxUeXBlPGFueT4gfCBJbmplY3Rpb25Ub2tlbjxhbnk+PiA9IG5ldyBTZXQoKTtcbiAgcHJvdGVjdGVkIHByb3ZpZGVyRGVmOiBNYXA8VHlwZTxhbnk+IHwgSW5qZWN0aW9uVG9rZW48YW55PiwgUHJvdmlkZXI+ID0gbmV3IE1hcCgpO1xuICBwcm90ZWN0ZWQgcmVwbGFjZURlZjogU2V0PFR5cGU8YW55PiB8IEluamVjdGlvblRva2VuPGFueT4+ID0gbmV3IFNldCgpO1xuXG4gIHB1YmxpYyBiZWZvcmVDb21waWxlQ29tcG9uZW50cyhjYWxsYmFjazogKHRlc3RCZWQ6IHR5cGVvZiBUZXN0QmVkKSA9PiB2b2lkKTogdGhpcyB7XG4gICAgdGhpcy5iZWZvcmVDQy5hZGQoY2FsbGJhY2spO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIGJ1aWxkKCk6IE5nTW9kdWxlIHtcbiAgICBjb25zdCBiYWNrdXAgPSB7XG4gICAgICBidWlsdERlY2xhcmF0aW9uczogbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0RGVjbGFyYXRpb25zLFxuICAgICAgYnVpbHRQcm92aWRlcnM6IG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycyxcbiAgICAgIGNhY2hlRGVjbGFyYXRpb25zOiBuZ01vY2tzVW5pdmVyc2UuY2FjaGVEZWNsYXJhdGlvbnMsXG4gICAgICBjYWNoZVByb3ZpZGVyczogbmdNb2Nrc1VuaXZlcnNlLmNhY2hlUHJvdmlkZXJzLFxuICAgICAgY29uZmlnOiBuZ01vY2tzVW5pdmVyc2UuY29uZmlnLFxuICAgICAgZmxhZ3M6IG5nTW9ja3NVbml2ZXJzZS5mbGFncyxcbiAgICAgIHRvdWNoZXM6IG5nTW9ja3NVbml2ZXJzZS50b3VjaGVzLFxuICAgIH07XG5cbiAgICBuZ01vY2tzVW5pdmVyc2UuYnVpbHREZWNsYXJhdGlvbnMgPSBuZXcgTWFwKCk7XG4gICAgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzID0gbmV3IE1hcCgpO1xuICAgIG5nTW9ja3NVbml2ZXJzZS5jYWNoZURlY2xhcmF0aW9ucyA9IG5ldyBNYXAoKTtcbiAgICBuZ01vY2tzVW5pdmVyc2UuY2FjaGVQcm92aWRlcnMgPSBuZXcgTWFwKCk7XG4gICAgbmdNb2Nrc1VuaXZlcnNlLmNvbmZpZyA9IG5ldyBNYXAoKTtcbiAgICBuZ01vY2tzVW5pdmVyc2UuZmxhZ3MgPSBuZXcgU2V0KFtcbiAgICAgICdjYWNoZUNvbXBvbmVudCcsXG4gICAgICAnY2FjaGVEaXJlY3RpdmUnLFxuICAgICAgJ2NhY2hlTW9kdWxlJyxcbiAgICAgICdjYWNoZVBpcGUnLFxuICAgICAgJ2NhY2hlUHJvdmlkZXInLFxuICAgICAgJ2NvcnJlY3RNb2R1bGVFeHBvcnRzJyxcbiAgICBdKTtcbiAgICBuZ01vY2tzVW5pdmVyc2UudG91Y2hlcyA9IG5ldyBTZXQoKTtcbiAgICBuZ01vY2tzVW5pdmVyc2UuY29uZmlnLnNldCgnbXVsdGknLCBuZXcgU2V0KCkpOyAvLyBjb2xsZWN0aW5nIG11bHRpIGZsYWdzIG9mIHByb3ZpZGVycy5cbiAgICBuZ01vY2tzVW5pdmVyc2UuY29uZmlnLnNldCgnZGVwcycsIG5ldyBTZXQoKSk7IC8vIGNvbGxlY3RpbmcgYWxsIGRlcHMgb2YgcHJvdmlkZXJzLlxuICAgIG5nTW9ja3NVbml2ZXJzZS5jb25maWcuc2V0KCdkZXBzU2tpcCcsIG5ldyBTZXQoKSk7IC8vIGNvbGxlY3RpbmcgYWxsIGRlY2xhcmF0aW9ucyBvZiBrZXB0IG1vZHVsZXMuXG4gICAgbmdNb2Nrc1VuaXZlcnNlLmNvbmZpZy5zZXQoJ3Jlc29sdXRpb24nLCBuZXcgTWFwKCkpOyAvLyBmbGFncyB0byB1bmRlcnN0YW5kIGhvdyB0byBtb2NrIG5lc3RlZCBkZWNsYXJhdGlvbnMuXG4gICAgZm9yIChjb25zdCBbaywgdl0gb2YgbWFwRW50cmllcyh0aGlzLmNvbmZpZ0RlZikpIHtcbiAgICAgIG5nTW9ja3NVbml2ZXJzZS5jb25maWcuc2V0KGssIHYpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgZGVmIG9mIG1hcFZhbHVlcyh0aGlzLmtlZXBEZWYpKSB7XG4gICAgICBuZ01vY2tzVW5pdmVyc2UuYnVpbHREZWNsYXJhdGlvbnMuc2V0KGRlZiwgZGVmKTtcbiAgICAgIG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycy5zZXQoZGVmLCBkZWYpO1xuICAgICAgbmdNb2Nrc1VuaXZlcnNlLmNvbmZpZy5nZXQoJ3Jlc29sdXRpb24nKS5zZXQoZGVmLCAna2VlcCcpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgZGVmIG9mIG1hcFZhbHVlcyh0aGlzLnJlcGxhY2VEZWYpKSB7XG4gICAgICBuZ01vY2tzVW5pdmVyc2UuYnVpbHREZWNsYXJhdGlvbnMuc2V0KGRlZiwgdGhpcy5kZWZWYWx1ZS5nZXQoZGVmKSk7XG4gICAgICBuZ01vY2tzVW5pdmVyc2UuY29uZmlnLmdldCgncmVzb2x1dGlvbicpLnNldChkZWYsICdyZXBsYWNlJyk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBkZWYgb2YgWy4uLm1hcFZhbHVlcyh0aGlzLmV4Y2x1ZGVEZWYpXSkge1xuICAgICAgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0RGVjbGFyYXRpb25zLnNldChkZWYsIG51bGwpO1xuICAgICAgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLnNldChkZWYsIG51bGwpO1xuICAgICAgbmdNb2Nrc1VuaXZlcnNlLmNvbmZpZy5nZXQoJ3Jlc29sdXRpb24nKS5zZXQoZGVmLCAnZXhjbHVkZScpO1xuICAgIH1cblxuICAgIC8vIE1vY2tpbmcgcmVxdWVzdGVkIHRoaW5ncy5cbiAgICBmb3IgKGNvbnN0IGRlZiBvZiBtYXBWYWx1ZXModGhpcy5tb2NrRGVmKSkge1xuICAgICAgbmdNb2Nrc1VuaXZlcnNlLmNvbmZpZy5nZXQoJ3Jlc29sdXRpb24nKS5zZXQoZGVmLCAnbW9jaycpO1xuXG4gICAgICBpZiAoaXNOZ0RlZihkZWYsICdjJykpIHtcbiAgICAgICAgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0RGVjbGFyYXRpb25zLnNldChkZWYsIE1vY2tDb21wb25lbnQoZGVmKSk7XG4gICAgICB9XG4gICAgICBpZiAoaXNOZ0RlZihkZWYsICdkJykpIHtcbiAgICAgICAgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0RGVjbGFyYXRpb25zLnNldChkZWYsIE1vY2tEaXJlY3RpdmUoZGVmKSk7XG4gICAgICB9XG4gICAgICBpZiAoaXNOZ0RlZihkZWYsICdwJykpIHtcbiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSB0aGlzLmRlZlZhbHVlLmdldChkZWYpO1xuICAgICAgICBuZ01vY2tzVW5pdmVyc2UuYnVpbHREZWNsYXJhdGlvbnMuc2V0KFxuICAgICAgICAgIGRlZixcbiAgICAgICAgICB0eXBlb2YgaW5zdGFuY2UgPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgID8gTW9ja1BpcGUoZGVmLCBpbnN0YW5jZSlcbiAgICAgICAgICAgIDogaW5zdGFuY2UgJiYgdHlwZW9mIGluc3RhbmNlID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgaW5zdGFuY2UudHJhbnNmb3JtID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgICA/IE1vY2tQaXBlKGRlZiwgaW5zdGFuY2UudHJhbnNmb3JtKVxuICAgICAgICAgICAgOiBNb2NrUGlwZShkZWYpXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmIChpc05nRGVmKGRlZiwgJ2knKSAmJiB0aGlzLmRlZlZhbHVlLmhhcyhkZWYpKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5kZWZWYWx1ZS5nZXQoZGVmKTtcbiAgICAgICAgY29uc3QgaXNGdW5jID0gaXNOZ0RlZihkZWYsICdwJykgJiYgdHlwZW9mIGluc3RhbmNlID09PSAnZnVuY3Rpb24nO1xuICAgICAgICBuZ01vY2tzVW5pdmVyc2UuYnVpbHRQcm92aWRlcnMuc2V0KFxuICAgICAgICAgIGRlZixcbiAgICAgICAgICBtb2NrU2VydmljZUhlbHBlci51c2VGYWN0b3J5KGRlZiwgKCkgPT5cbiAgICAgICAgICAgIGlzRnVuYyA/IG5nTW9ja3Muc3R1YihNb2NrU2VydmljZShkZWYpLCB7IHRyYW5zZm9ybTogaW5zdGFuY2UgfSkgOiBpbnN0YW5jZVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoaXNOZ0RlZihkZWYsICdpJykpIHtcbiAgICAgICAgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLnNldChkZWYsIE1vY2tQcm92aWRlcihkZWYpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpc05nRGVmKGRlZikgJiYgdGhpcy5kZWZWYWx1ZS5oYXMoZGVmKSkge1xuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMuZGVmVmFsdWUuZ2V0KGRlZik7XG4gICAgICAgIG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycy5zZXQoXG4gICAgICAgICAgZGVmLFxuICAgICAgICAgIG1vY2tTZXJ2aWNlSGVscGVyLnVzZUZhY3RvcnkoZGVmLCAoKSA9PiBpbnN0YW5jZSlcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoIWlzTmdEZWYoZGVmKSkge1xuICAgICAgICBuZ01vY2tzVW5pdmVyc2UuYnVpbHRQcm92aWRlcnMuc2V0KGRlZiwgTW9ja1Byb3ZpZGVyKGRlZikpO1xuICAgICAgfVxuXG4gICAgICBuZ01vY2tzVW5pdmVyc2UudG91Y2hlcy5kZWxldGUoZGVmKTtcbiAgICB9XG5cbiAgICAvLyBOb3cgd2UgbmVlZCB0byBydW4gdGhyb3VnaCByZXF1ZXN0ZWQgbW9kdWxlcy5cbiAgICBjb25zdCBkZWZQcm92aWRlcnMgPSBuZXcgTWFwKCk7XG4gICAgZm9yIChjb25zdCBkZWYgb2YgWy4uLm1hcFZhbHVlcyh0aGlzLmtlZXBEZWYpLCAuLi5tYXBWYWx1ZXModGhpcy5tb2NrRGVmKSwgLi4ubWFwVmFsdWVzKHRoaXMucmVwbGFjZURlZildKSB7XG4gICAgICBpZiAoIWlzTmdEZWYoZGVmLCAnbScpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5kZWZQcm92aWRlcnMuaGFzKGRlZikgJiYgdGhpcy5tb2NrRGVmLmhhcyhkZWYpKSB7XG4gICAgICAgIGNvbnN0IFssIGxvRGVmXSA9IE1vY2tOZ0RlZih7IHByb3ZpZGVyczogdGhpcy5kZWZQcm92aWRlcnMuZ2V0KGRlZikgfSk7XG4gICAgICAgIGRlZlByb3ZpZGVycy5zZXQoZGVmLCBsb0RlZi5wcm92aWRlcnMpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmRlZlByb3ZpZGVycy5oYXMoZGVmKSkge1xuICAgICAgICBkZWZQcm92aWRlcnMuc2V0KGRlZiwgdGhpcy5kZWZQcm92aWRlcnMuZ2V0KGRlZikpO1xuICAgICAgfVxuXG4gICAgICBuZ01vY2tzVW5pdmVyc2UuYnVpbHREZWNsYXJhdGlvbnMuc2V0KGRlZiwgTW9ja01vZHVsZShkZWYpKTtcbiAgICAgIG5nTW9ja3NVbml2ZXJzZS50b3VjaGVzLmRlbGV0ZShkZWYpO1xuICAgIH1cblxuICAgIC8vIFNldHRpbmcgdXAgVGVzdEJlZC5cbiAgICBjb25zdCBpbXBvcnRzOiBBcnJheTxUeXBlPGFueT4gfCBOZ01vZHVsZVdpdGhQcm92aWRlcnM+ID0gW107XG4gICAgY29uc3QgZGVjbGFyYXRpb25zOiBBcnJheTxUeXBlPGFueT4+ID0gW107XG4gICAgY29uc3QgcHJvdmlkZXJzOiBQcm92aWRlcltdID0gW107XG5cbiAgICAvLyBBZGRpbmcgc3VpdGFibGUgbGVmdG92ZXJzLlxuICAgIGZvciAoY29uc3QgZGVmIG9mIFsuLi5tYXBWYWx1ZXModGhpcy5tb2NrRGVmKSwgLi4ubWFwVmFsdWVzKHRoaXMua2VlcERlZiksIC4uLm1hcFZhbHVlcyh0aGlzLnJlcGxhY2VEZWYpXSkge1xuICAgICAgaWYgKGlzTmdEZWYoZGVmLCAnaScpIHx8ICFpc05nRGVmKGRlZikpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAobmdNb2Nrc1VuaXZlcnNlLnRvdWNoZXMuaGFzKGRlZikpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuY29uZmlnRGVmLmdldChkZWYpO1xuICAgICAgaWYgKGNvbmZpZyAmJiBjb25maWcuZGVwZW5kZW5jeSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGlzTmdEZWYoZGVmLCAnbScpKSB7XG4gICAgICAgIGNvbnN0IGxvTW9kdWxlID0gbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0RGVjbGFyYXRpb25zLmdldChkZWYpO1xuICAgICAgICBjb25zdCBsb1Byb3ZpZGVycyA9IGRlZlByb3ZpZGVycy5oYXMoZGVmKSA/IGRlZlByb3ZpZGVycy5nZXQoZGVmKSA6IHVuZGVmaW5lZDtcbiAgICAgICAgaW1wb3J0cy5wdXNoKFxuICAgICAgICAgIGxvUHJvdmlkZXJzXG4gICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICBuZ01vZHVsZTogbG9Nb2R1bGUsXG4gICAgICAgICAgICAgICAgcHJvdmlkZXJzOiBsb1Byb3ZpZGVycyxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiBsb01vZHVsZVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGVjbGFyYXRpb25zLnB1c2gobmdNb2Nrc1VuaXZlcnNlLmJ1aWx0RGVjbGFyYXRpb25zLmdldChkZWYpKTtcbiAgICAgIH1cblxuICAgICAgbmdNb2Nrc1VuaXZlcnNlLnRvdWNoZXMuYWRkKGRlZik7XG4gICAgfVxuXG4gICAgLy8gQWRkaW5nIG1pc3NlZCBrZXB0IHByb3ZpZGVycyB0byB0ZXN0IGJlZC5cbiAgICBmb3IgKGNvbnN0IGRlZiBvZiBtYXBWYWx1ZXModGhpcy5rZWVwRGVmKSkge1xuICAgICAgaWYgKCFpc05nRGVmKGRlZiwgJ2knKSAmJiBpc05nRGVmKGRlZikpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChuZ01vY2tzVW5pdmVyc2UudG91Y2hlcy5oYXMoZGVmKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29uZmlnID0gdGhpcy5jb25maWdEZWYuZ2V0KGRlZik7XG4gICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5kZXBlbmRlbmN5KSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoaXNOZ0luamVjdGlvblRva2VuKGRlZikpIHtcbiAgICAgICAgbmdNb2Nrc1VuaXZlcnNlLnRvdWNoZXMuYWRkKGRlZik7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgcHJvdmlkZXJzLnB1c2goZGVmKTtcbiAgICAgIG5nTW9ja3NVbml2ZXJzZS50b3VjaGVzLmFkZChkZWYpO1xuICAgIH1cblxuICAgIC8vIEFkZGluZyBtaXNzZWQgbW9jayBwcm92aWRlcnMgdG8gdGVzdCBiZWQuXG4gICAgZm9yIChjb25zdCBkZWYgb2YgbWFwVmFsdWVzKHRoaXMubW9ja0RlZikpIHtcbiAgICAgIGlmICghaXNOZ0RlZihkZWYsICdpJykgJiYgaXNOZ0RlZihkZWYpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAobmdNb2Nrc1VuaXZlcnNlLnRvdWNoZXMuaGFzKGRlZikpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuY29uZmlnRGVmLmdldChkZWYpO1xuICAgICAgaWYgKGNvbmZpZyAmJiBjb25maWcuZGVwZW5kZW5jeSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbW9jayA9IG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycy5nZXQoZGVmKTtcbiAgICAgIHByb3ZpZGVycy5wdXNoKG1vY2sgfHwgeyBwcm92aWRlOiBkZWYsIHVzZVZhbHVlOiB1bmRlZmluZWQgfSk7XG4gICAgICBuZ01vY2tzVW5pdmVyc2UudG91Y2hlcy5hZGQoZGVmKTtcbiAgICB9XG5cbiAgICAvLyBBZGRpbmcgcmVxdWVzdGVkIHByb3ZpZGVycyB0byB0ZXN0IGJlZC5cbiAgICBmb3IgKGNvbnN0IHByb3ZpZGVyIG9mIG1hcFZhbHVlcyh0aGlzLnByb3ZpZGVyRGVmKSkge1xuICAgICAgcHJvdmlkZXJzLnB1c2gocHJvdmlkZXIpO1xuICAgIH1cblxuICAgIC8vIEFuYWx5emluZyBwcm92aWRlcnMuXG4gICAgZm9yIChjb25zdCBwcm92aWRlciBvZiBmbGF0dGVuKHByb3ZpZGVycykpIHtcbiAgICAgIGNvbnN0IHByb3ZpZGUgPSB0eXBlb2YgcHJvdmlkZXIgPT09ICdvYmplY3QnICYmIChwcm92aWRlciBhcyBhbnkpLnByb3ZpZGUgPyAocHJvdmlkZXIgYXMgYW55KS5wcm92aWRlIDogcHJvdmlkZXI7XG4gICAgICBuZ01vY2tzVW5pdmVyc2UudG91Y2hlcy5hZGQocHJvdmlkZSk7XG5cbiAgICAgIGlmIChwcm92aWRlICE9PSBwcm92aWRlciAmJiAocHJvdmlkZXIgYXMgYW55KS5kZXBzKSB7XG4gICAgICAgIGV4dHJhY3REZXBlbmRlbmN5KChwcm92aWRlciBhcyBhbnkpLmRlcHMsIG5nTW9ja3NVbml2ZXJzZS5jb25maWcuZ2V0KCdkZXBzJykpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE1vY2tpbmcgcm9vdCBwcm92aWRlcnMuXG4gICAgY29uc3QgcGFyYW1ldGVycyA9IG5ldyBTZXQ8YW55PigpO1xuICAgIGlmICghdGhpcy5rZWVwRGVmLmhhcyhOR19NT0NLU19ST09UX1BST1ZJREVSUykpIHtcbiAgICAgIC8vIFdlIG5lZWQgYnVja2V0cyBoZXJlIHRvIHByb2Nlc3MgZmlyc3QgYWxsIGRlcHNTa2lwLCB0aGVuIGRlcHMgYW5kIG9ubHkgYWZ0ZXIgdGhhdCBhbGwgb3RoZXIgZGVmcy5cbiAgICAgIGNvbnN0IGJ1Y2tldHM6IGFueVtdID0gW107XG4gICAgICBidWNrZXRzLnB1c2gobWFwVmFsdWVzKG5nTW9ja3NVbml2ZXJzZS5jb25maWcuZ2V0KCdkZXBzU2tpcCcpKSk7XG4gICAgICBidWNrZXRzLnB1c2gobWFwVmFsdWVzKG5nTW9ja3NVbml2ZXJzZS5jb25maWcuZ2V0KCdkZXBzJykpKTtcbiAgICAgIGJ1Y2tldHMucHVzaChtYXBWYWx1ZXMobmdNb2Nrc1VuaXZlcnNlLnRvdWNoZXMpKTtcbiAgICAgIC8vIEFsc28gd2UgbmVlZCB0byB0cmFjayB3aGF0IGhhcyBiZWVuIHRvdWNoZWQgdG8gY2hlY2sgcGFyYW1zIHJlY3Vyc2l2ZWx5LCBidXQgYXZvaWRpbmcgZHVwbGljYXRlcy5cbiAgICAgIGNvbnN0IHRvdWNoZWQ6IGFueVtdID0gW10uY29uY2F0KC4uLmJ1Y2tldHMpO1xuICAgICAgZm9yIChjb25zdCBidWNrZXQgb2YgYnVja2V0cykge1xuICAgICAgICBmb3IgKGNvbnN0IGRlZiBvZiBidWNrZXQpIHtcbiAgICAgICAgICBpZiAoIXNraXBEZXAoZGVmKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMubW9ja0RlZi5oYXMoTkdfTU9DS1NfUk9PVF9QUk9WSURFUlMpIHx8ICFuZ01vY2tzVW5pdmVyc2UuY29uZmlnLmdldCgnZGVwc1NraXAnKS5oYXMoZGVmKSkge1xuICAgICAgICAgICAgICBwYXJhbWV0ZXJzLmFkZChkZWYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGZvciAoY29uc3QgZGVjb3JhdG9ycyBvZiBqaXRSZWZsZWN0b3IucGFyYW1ldGVycyhkZWYpKSB7XG4gICAgICAgICAgICBjb25zdCBwcm92aWRlOiBhbnkgPSBleHRyYWN0RGVwKGRlY29yYXRvcnMpO1xuICAgICAgICAgICAgaWYgKHNraXBEZXAocHJvdmlkZSkpIHtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobmdNb2Nrc1VuaXZlcnNlLmNvbmZpZy5nZXQoJ2RlcHNTa2lwJykuaGFzKHByb3ZpZGUpKSB7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm92aWRlID09PSAnZnVuY3Rpb24nICYmIHRvdWNoZWQuaW5kZXhPZihwcm92aWRlKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgdG91Y2hlZC5wdXNoKHByb3ZpZGUpO1xuICAgICAgICAgICAgICBidWNrZXQucHVzaChwcm92aWRlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMubW9ja0RlZi5oYXMoTkdfTU9DS1NfUk9PVF9QUk9WSURFUlMpIHx8ICFuZ01vY2tzVW5pdmVyc2UuY29uZmlnLmdldCgnZGVwc1NraXAnKS5oYXMoZGVmKSkge1xuICAgICAgICAgICAgICBwYXJhbWV0ZXJzLmFkZChwcm92aWRlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIG5nTW9ja3NVbml2ZXJzZS5jb25maWcuZ2V0KCdkZXBzU2tpcCcpLmFkZChwcm92aWRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBZGRpbmcgbWlzc2VkIHByb3ZpZGVycy5cbiAgICBpZiAocGFyYW1ldGVycy5zaXplKSB7XG4gICAgICBjb25zdCBwYXJhbWV0ZXJzTWFwID0gbmV3IE1hcCgpO1xuICAgICAgZm9yIChjb25zdCBwYXJhbWV0ZXIgb2YgbWFwVmFsdWVzKHBhcmFtZXRlcnMpKSB7XG4gICAgICAgIGNvbnN0IG1vY2sgPSBtb2NrU2VydmljZUhlbHBlci5yZXNvbHZlUHJvdmlkZXIocGFyYW1ldGVyLCBwYXJhbWV0ZXJzTWFwKTtcbiAgICAgICAgaWYgKG1vY2spIHtcbiAgICAgICAgICBwcm92aWRlcnMucHVzaChtb2NrKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc05nSW5qZWN0aW9uVG9rZW4ocGFyYW1ldGVyKSkge1xuICAgICAgICAgIGNvbnN0IG11bHRpID0gbmdNb2Nrc1VuaXZlcnNlLmNvbmZpZy5oYXMoJ211bHRpJykgJiYgbmdNb2Nrc1VuaXZlcnNlLmNvbmZpZy5nZXQoJ211bHRpJykuaGFzKHBhcmFtZXRlcik7XG4gICAgICAgICAgcHJvdmlkZXJzLnB1c2gobW9ja1NlcnZpY2VIZWxwZXIudXNlRmFjdG9yeShwYXJhbWV0ZXIsICgpID0+IChtdWx0aSA/IFtdIDogdW5kZWZpbmVkKSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbW9ja3MgPSBuZXcgTWFwKCk7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgW1xuICAgICAgLi4ubWFwRW50cmllcyhuZ01vY2tzVW5pdmVyc2UuYnVpbHRQcm92aWRlcnMpLFxuICAgICAgLi4ubWFwRW50cmllcyhuZ01vY2tzVW5pdmVyc2UuYnVpbHREZWNsYXJhdGlvbnMpLFxuICAgICAgLi4ubWFwRW50cmllcyhuZ01vY2tzVW5pdmVyc2UuY2FjaGVEZWNsYXJhdGlvbnMpLFxuICAgICAgLi4ubWFwRW50cmllcyhuZ01vY2tzVW5pdmVyc2UuY2FjaGVQcm92aWRlcnMpLFxuICAgIF0pIHtcbiAgICAgIGlmIChtb2Nrcy5oYXMoa2V5KSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIG1vY2tzLnNldChrZXksIHZhbHVlKTtcbiAgICB9XG5cbiAgICBwcm92aWRlcnMucHVzaCh7XG4gICAgICBwcm92aWRlOiBOR19NT0NLUyxcbiAgICAgIHVzZVZhbHVlOiBtb2NrcyxcbiAgICB9KTtcblxuICAgIC8vIFJlZGVmaW5pbmcgcHJvdmlkZXJzIGZvciBrZXB0IGRlY2xhcmF0aW9ucy5cbiAgICBjb25zdCB0b3VjaGVzID0gbmV3IFNldCgpO1xuICAgIHByb3ZpZGVycy5wdXNoKHtcbiAgICAgIHByb3ZpZGU6IE5HX01PQ0tTX1RPVUNIRVMsXG4gICAgICB1c2VWYWx1ZTogdG91Y2hlcyxcbiAgICB9KTtcbiAgICBjb25zdCBvdmVycmlkZXM6IE1hcDxUeXBlPGFueT4sIE1ldGFkYXRhT3ZlcnJpZGU8YW55Pj4gPSBuZXcgTWFwKCk7XG4gICAgcHJvdmlkZXJzLnB1c2goe1xuICAgICAgcHJvdmlkZTogTkdfTU9DS1NfT1ZFUlJJREVTLFxuICAgICAgdXNlVmFsdWU6IG92ZXJyaWRlcyxcbiAgICB9KTtcbiAgICBmb3IgKGNvbnN0IHByb3RvIG9mIG1hcFZhbHVlcyhuZ01vY2tzVW5pdmVyc2UudG91Y2hlcykpIHtcbiAgICAgIGNvbnN0IHNvdXJjZTogYW55ID0gcHJvdG87XG4gICAgICBsZXQgdmFsdWUgPSBuZ01vY2tzVW5pdmVyc2UuYnVpbHREZWNsYXJhdGlvbnMuZ2V0KHNvdXJjZSk7XG5cbiAgICAgIC8vIGtlcHQgZGVjbGFyYXRpb25zIHNob3VsZCBiZSBiYXNlZCBvbiB0aGVpciBzb3VyY2UuXG4gICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB2YWx1ZSA9IHNvdXJjZTtcbiAgICAgIH1cblxuICAgICAgdG91Y2hlcy5hZGQoc291cmNlKTtcbiAgICAgIHRvdWNoZXMuYWRkKHZhbHVlKTtcblxuICAgICAgLy8gbm8gcmVhc29uIHRvIHRvdWNoIG1vY2tzXG4gICAgICBpZiAobmdNb2Nrc1VuaXZlcnNlLmNhY2hlRGVjbGFyYXRpb25zLmhhcyh2YWx1ZSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIC8vIG5vIGN1c3RvbWl6YXRpb25zIGluIHJlcGxhY2VtZW50c1xuICAgICAgaWYgKHRoaXMucmVwbGFjZURlZi5oYXMoc291cmNlKSAmJiB2YWx1ZSA9PT0gdGhpcy5kZWZWYWx1ZS5nZXQoc291cmNlKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgbGV0IG1ldGE6IE5nTW9kdWxlIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKGlzTmdEZWYodmFsdWUsICdjJykpIHtcbiAgICAgICAgbWV0YSA9IGRpcmVjdGl2ZVJlc29sdmVyLnJlc29sdmUodmFsdWUpO1xuICAgICAgfSBlbHNlIGlmIChpc05nRGVmKHZhbHVlLCAnZCcpKSB7XG4gICAgICAgIG1ldGEgPSBkaXJlY3RpdmVSZXNvbHZlci5yZXNvbHZlKHZhbHVlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBza2lwTW9jayA9IG5nTW9ja3NVbml2ZXJzZS5mbGFncy5oYXMoJ3NraXBNb2NrJyk7XG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqL1xuICAgICAgaWYgKCFza2lwTW9jaykge1xuICAgICAgICBuZ01vY2tzVW5pdmVyc2UuZmxhZ3MuYWRkKCdza2lwTW9jaycpO1xuICAgICAgfVxuICAgICAgY29uc3QgW2NoYW5nZWQsIGRlZl0gPSBNb2NrTmdEZWYoeyBwcm92aWRlcnM6IG1ldGEucHJvdmlkZXJzIH0pO1xuICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgIGlmICghc2tpcE1vY2spIHtcbiAgICAgICAgbmdNb2Nrc1VuaXZlcnNlLmZsYWdzLmRlbGV0ZSgnc2tpcE1vY2snKTtcbiAgICAgIH1cbiAgICAgIGlmICghY2hhbmdlZCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG92ZXJyaWRlOiBNZXRhZGF0YU92ZXJyaWRlPE5nTW9kdWxlPiA9IHtcbiAgICAgICAgc2V0OiBkZWYsXG4gICAgICB9O1xuICAgICAgb3ZlcnJpZGVzLnNldCh2YWx1ZSwgb3ZlcnJpZGUpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGJhY2t1cCkpIHtcbiAgICAgIG5nTW9ja3NVbml2ZXJzZVtrZXldID0gKGJhY2t1cCBhcyBhbnkpW2tleV07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRlY2xhcmF0aW9ucyxcbiAgICAgIGltcG9ydHMsXG4gICAgICBwcm92aWRlcnMsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBleGNsdWRlKGRlZjogYW55KTogdGhpcyB7XG4gICAgdGhpcy53aXBlKGRlZik7XG4gICAgdGhpcy5leGNsdWRlRGVmLmFkZChkZWYpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMga2VlcChpbnB1dDogYW55LCBjb25maWc/OiBJTW9ja0J1aWxkZXJDb25maWcpOiB0aGlzIHtcbiAgICBjb25zdCB7IGRlZiwgcHJvdmlkZXJzIH0gPSBpc05nTW9kdWxlRGVmV2l0aFByb3ZpZGVycyhpbnB1dClcbiAgICAgID8geyBkZWY6IGlucHV0Lm5nTW9kdWxlLCBwcm92aWRlcnM6IGlucHV0LnByb3ZpZGVycyB9XG4gICAgICA6IHsgZGVmOiBpbnB1dCwgcHJvdmlkZXJzOiB1bmRlZmluZWQgfTtcblxuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5rZWVwRGVmLmhhcyhkZWYpID8gdGhpcy5kZWZQcm92aWRlcnMuZ2V0KGRlZikgOiBbXTtcbiAgICB0aGlzLndpcGUoZGVmKTtcbiAgICB0aGlzLmtlZXBEZWYuYWRkKGRlZik7XG5cbiAgICAvLyBhIG1hZ2ljIHRvIHN1cHBvcnQgbW9kdWxlcyB3aXRoIHByb3ZpZGVycy5cbiAgICBpZiAocHJvdmlkZXJzKSB7XG4gICAgICB0aGlzLmRlZlByb3ZpZGVycy5zZXQoZGVmLCBbLi4uZXhpc3RpbmcsIC4uLnByb3ZpZGVyc10pO1xuICAgIH1cblxuICAgIGlmIChjb25maWcpIHtcbiAgICAgIHRoaXMuY29uZmlnRGVmLnNldChkZWYsIGNvbmZpZyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29uZmlnRGVmLmRlbGV0ZShkZWYpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIG1vY2soaW5wdXQ6IGFueSwgYTE6IGFueSA9IGRlZmF1bHRNb2NrLCBhMj86IGFueSk6IHRoaXMge1xuICAgIGNvbnN0IHsgZGVmLCBwcm92aWRlcnMgfSA9IGlzTmdNb2R1bGVEZWZXaXRoUHJvdmlkZXJzKGlucHV0KVxuICAgICAgPyB7IGRlZjogaW5wdXQubmdNb2R1bGUsIHByb3ZpZGVyczogaW5wdXQucHJvdmlkZXJzIH1cbiAgICAgIDogeyBkZWY6IGlucHV0LCBwcm92aWRlcnM6IHVuZGVmaW5lZCB9O1xuXG4gICAgbGV0IG1vY2s6IGFueSA9IGRlZiA9PT0gYTEgPyBkZWZhdWx0TW9jayA6IGExO1xuICAgIGxldCBjb25maWc6IGFueSA9IGEyID8gYTIgOiBhMSAhPT0gZGVmYXVsdE1vY2sgPyBhMSA6IHVuZGVmaW5lZDtcbiAgICBpZiAoaXNOZ0RlZihkZWYsICdwJykgJiYgdHlwZW9mIGExID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBtb2NrID0gYTE7XG4gICAgICBjb25maWcgPSBhMjtcbiAgICB9IGVsc2UgaWYgKGlzTmdEZWYoZGVmLCAnaScpIHx8ICFpc05nRGVmKGRlZikpIHtcbiAgICAgIGNvbmZpZyA9IGEyO1xuICAgIH1cbiAgICBtb2NrID0gbW9jayA9PT0gY29uZmlnID8gZGVmYXVsdE1vY2sgOiBtb2NrO1xuXG4gICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLm1vY2tEZWYuaGFzKGRlZikgPyB0aGlzLmRlZlByb3ZpZGVycy5nZXQoZGVmKSA6IFtdO1xuICAgIHRoaXMud2lwZShkZWYpO1xuICAgIHRoaXMubW9ja0RlZi5hZGQoZGVmKTtcblxuICAgIC8vIGEgbWFnaWMgdG8gc3VwcG9ydCBtb2R1bGVzIHdpdGggcHJvdmlkZXJzLlxuICAgIGlmIChwcm92aWRlcnMpIHtcbiAgICAgIHRoaXMuZGVmUHJvdmlkZXJzLnNldChkZWYsIFsuLi5leGlzdGluZywgLi4ucHJvdmlkZXJzXSk7XG4gICAgfVxuXG4gICAgaWYgKG1vY2sgIT09IGRlZmF1bHRNb2NrKSB7XG4gICAgICB0aGlzLmRlZlZhbHVlLnNldChkZWYsIG1vY2spO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRlZlZhbHVlLmRlbGV0ZShkZWYpO1xuICAgIH1cblxuICAgIGlmIChjb25maWcpIHtcbiAgICAgIHRoaXMuY29uZmlnRGVmLnNldChkZWYsIGNvbmZpZyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29uZmlnRGVmLmRlbGV0ZShkZWYpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHByb3ZpZGUoZGVmOiBQcm92aWRlcik6IHRoaXMge1xuICAgIGZvciAoY29uc3QgcHJvdmlkZXIgb2YgZmxhdHRlbihkZWYpKSB7XG4gICAgICBjb25zdCBwcm92aWRlID0gdHlwZW9mIHByb3ZpZGVyID09PSAnb2JqZWN0JyAmJiBwcm92aWRlci5wcm92aWRlID8gcHJvdmlkZXIucHJvdmlkZSA6IHByb3ZpZGVyO1xuICAgICAgY29uc3QgbXVsdGkgPSB0eXBlb2YgcHJvdmlkZXIgPT09ICdvYmplY3QnICYmIHByb3ZpZGVyLnByb3ZpZGUgJiYgcHJvdmlkZXIubXVsdGk7XG4gICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMucHJvdmlkZXJEZWYuaGFzKHByb3ZpZGUpID8gdGhpcy5wcm92aWRlckRlZi5nZXQocHJvdmlkZSkgOiBbXTtcbiAgICAgIHRoaXMud2lwZShwcm92aWRlKTtcbiAgICAgIHRoaXMucHJvdmlkZXJEZWYuc2V0KHByb3ZpZGUsIG11bHRpID8gWy4uLmV4aXN0aW5nLCBwcm92aWRlcl0gOiBwcm92aWRlcik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHJlcGxhY2Uoc291cmNlOiBUeXBlPGFueT4sIGRlc3RpbmF0aW9uOiBUeXBlPGFueT4sIGNvbmZpZz86IElNb2NrQnVpbGRlckNvbmZpZyk6IHRoaXMge1xuICAgIGlmICghaXNOZ0RlZihkZXN0aW5hdGlvbikgfHwgIWlzTmdEZWYoc291cmNlKSB8fCBpc05nRGVmKGRlc3RpbmF0aW9uLCAnaScpIHx8IGlzTmdEZWYoc291cmNlLCAnaScpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdDYW5ub3QgcmVwbGFjZSB0aGUgZGVjbGFyYXRpb24sIGJvdGggaGF2ZSB0byBiZSBhIE1vZHVsZSwgYSBDb21wb25lbnQsIGEgRGlyZWN0aXZlIG9yIGEgUGlwZSwgZm9yIFByb3ZpZGVycyB1c2UgYC5tb2NrYCBvciBgLnByb3ZpZGVgJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLndpcGUoc291cmNlKTtcbiAgICB0aGlzLnJlcGxhY2VEZWYuYWRkKHNvdXJjZSk7XG4gICAgdGhpcy5kZWZWYWx1ZS5zZXQoc291cmNlLCBkZXN0aW5hdGlvbik7XG5cbiAgICBpZiAoY29uZmlnKSB7XG4gICAgICB0aGlzLmNvbmZpZ0RlZi5zZXQoc291cmNlLCBjb25maWcpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNvbmZpZ0RlZi5kZWxldGUoc291cmNlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgdGhlbjxUUmVzdWx0MSA9IElNb2NrQnVpbGRlclJlc3VsdCwgVFJlc3VsdDIgPSBuZXZlcj4oXG4gICAgZnVsZmlsbD86ICh2YWx1ZTogSU1vY2tCdWlsZGVyUmVzdWx0KSA9PiBQcm9taXNlTGlrZTxUUmVzdWx0MT4sXG4gICAgcmVqZWN0PzogKHJlYXNvbjogYW55KSA9PiBQcm9taXNlTGlrZTxUUmVzdWx0Mj5cbiAgKTogUHJvbWlzZUxpa2U8VFJlc3VsdDEgfCBUUmVzdWx0Mj4ge1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKHZhbHVlOiBJTW9ja0J1aWxkZXJSZXN1bHQpID0+IHZvaWQpOiB2b2lkID0+IHtcbiAgICAgIGNvbnN0IHRlc3RCZWQgPSBUZXN0QmVkLmNvbmZpZ3VyZVRlc3RpbmdNb2R1bGUodGhpcy5idWlsZCgpKTtcbiAgICAgIGZvciAoY29uc3QgY2FsbGJhY2sgb2YgbWFwVmFsdWVzKHRoaXMuYmVmb3JlQ0MpKSB7XG4gICAgICAgIGNhbGxiYWNrKHRlc3RCZWQpO1xuICAgICAgfVxuICAgICAgY29uc3QgdGVzdEJlZFByb21pc2UgPSB0ZXN0QmVkLmNvbXBpbGVDb21wb25lbnRzKCk7XG4gICAgICB0ZXN0QmVkUHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgICAgcmVzb2x2ZSh7IHRlc3RCZWQgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bGZpbGwsIHJlamVjdCk7XG4gIH1cblxuICBwcml2YXRlIHdpcGUoZGVmOiBUeXBlPGFueT4pOiB2b2lkIHtcbiAgICB0aGlzLmRlZlByb3ZpZGVycy5kZWxldGUoZGVmKTtcbiAgICB0aGlzLmRlZlZhbHVlLmRlbGV0ZShkZWYpO1xuICAgIHRoaXMuZXhjbHVkZURlZi5kZWxldGUoZGVmKTtcbiAgICB0aGlzLmtlZXBEZWYuZGVsZXRlKGRlZik7XG4gICAgdGhpcy5tb2NrRGVmLmRlbGV0ZShkZWYpO1xuICAgIHRoaXMucHJvdmlkZXJEZWYuZGVsZXRlKGRlZik7XG4gICAgdGhpcy5yZXBsYWNlRGVmLmRlbGV0ZShkZWYpO1xuICB9XG59XG4iXX0=