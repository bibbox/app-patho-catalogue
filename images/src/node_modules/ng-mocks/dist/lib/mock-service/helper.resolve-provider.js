"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_helpers_1 = require("../common/core.helpers");
var core_tokens_1 = require("../common/core.tokens");
var func_is_ng_injection_token_1 = require("../common/func.is-ng-injection-token");
var ng_mocks_universe_1 = require("../common/ng-mocks-universe");
var helper_1 = require("./helper");
var mock_provider_1 = require("./mock-provider");
// tries to resolve a provider based on current universe state.
exports.default = (function (def, resolutions, changed) {
    var _a;
    var provider = typeof def === 'object' && def.provide ? def.provide : def;
    var multi = def !== provider && !!def.multi;
    //  we shouldn't touch our system providers.
    if (typeof def === 'object' && def.useExisting && def.useExisting.__ngMocksSkip) {
        return def;
    }
    var mockDef;
    if (resolutions.has(provider)) {
        mockDef = resolutions.get(provider);
        var existingMock = ng_mocks_universe_1.default.builtProviders.get(provider);
        if (existingMock) {
            mockDef = existingMock;
        }
        // A case when a provider is actually a component, directive, pipe.
        if (typeof mockDef === 'function') {
            mockDef = {
                provide: provider,
                useClass: mockDef,
            };
        }
        return multi && typeof mockDef === 'object' ? __assign(__assign({}, mockDef), { multi: multi }) : mockDef;
    }
    //  we shouldn't touch excluded providers.
    if (ng_mocks_universe_1.default.builtProviders.has(provider) && ng_mocks_universe_1.default.builtProviders.get(provider) === null) {
        /* istanbul ignore else */
        if (changed) {
            changed(true);
        }
        return;
    }
    if (provider !== def && def.deps) {
        core_helpers_1.extractDependency(def.deps, ng_mocks_universe_1.default.config.get('deps'));
    }
    if (ng_mocks_universe_1.default.builtProviders.has(core_tokens_1.NG_MOCKS_INTERCEPTORS) &&
        ng_mocks_universe_1.default.builtProviders.get(core_tokens_1.NG_MOCKS_INTERCEPTORS) === null &&
        func_is_ng_injection_token_1.isNgInjectionToken(provider) &&
        provider.toString() === 'InjectionToken HTTP_INTERCEPTORS' &&
        provider !== def) {
        if (def.useFactory || def.useValue) {
            /* istanbul ignore else */
            if (changed) {
                changed(true);
            }
            return;
        }
        var interceptor = def.useExisting || def.useClass;
        if (!ng_mocks_universe_1.default.builtProviders.has(interceptor) || ng_mocks_universe_1.default.builtProviders.get(interceptor) === null) {
            /* istanbul ignore else */
            if (changed) {
                changed(true);
            }
            return;
        }
    }
    // Then we check decisions whether we should keep or replace a def.
    if (ng_mocks_universe_1.default.builtProviders.has(provider)) {
        mockDef = ng_mocks_universe_1.default.builtProviders.get(provider);
        if (mockDef === provider) {
            mockDef = def;
        }
        else if (mockDef === undefined) {
            mockDef = {
                provide: provider,
                useValue: undefined,
            };
        }
    }
    if (!mockDef && ng_mocks_universe_1.default.flags.has('skipMock')) {
        (_a = ng_mocks_universe_1.default.config.get('depsSkip')) === null || _a === void 0 ? void 0 : _a.add(provider);
        mockDef = def;
    }
    if (!mockDef) {
        mockDef = mock_provider_1.default(def);
    }
    // if provider is a value, we need to go through the value and to replace all mock instances.
    if (provider !== def && mockDef && mockDef.useValue) {
        var useValue = helper_1.default.replaceWithMocks(mockDef.useValue);
        mockDef =
            useValue === mockDef.useValue
                ? mockDef
                : __assign(__assign({}, mockDef), { useValue: useValue });
    }
    if (!func_is_ng_injection_token_1.isNgInjectionToken(provider) || def !== mockDef) {
        resolutions.set(provider, mockDef);
    }
    var differs = false;
    if (def === provider && mockDef !== def) {
        differs = true;
    }
    else if (def !== provider &&
        (!mockDef ||
            def.provide !== mockDef.provide ||
            def.useValue !== mockDef.useValue ||
            def.useClass !== mockDef.useClass ||
            def.useExisting !== mockDef.useExisting ||
            def.useFactory !== mockDef.useFactory ||
            def.deps !== mockDef.deps)) {
        differs = true;
    }
    if (changed && differs) {
        changed(true);
    }
    // Touching only when we really provide a value.
    if (mockDef) {
        ng_mocks_universe_1.default.touches.add(provider);
    }
    return multi && typeof mockDef === 'object' ? __assign(__assign({}, mockDef), { multi: multi }) : mockDef;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVyLnJlc29sdmUtcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvbW9jay1zZXJ2aWNlL2hlbHBlci5yZXNvbHZlLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSx1REFBMkQ7QUFDM0QscURBQThEO0FBQzlELG1GQUEwRTtBQUMxRSxpRUFBMEQ7QUFFMUQsbUNBQXlDO0FBQ3pDLGlEQUEyQztBQUUzQywrREFBK0Q7QUFDL0QsbUJBQWUsVUFBQyxHQUFRLEVBQUUsV0FBMEIsRUFBRSxPQUFpQzs7SUFDckYsSUFBTSxRQUFRLEdBQUcsT0FBTyxHQUFHLEtBQUssUUFBUSxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztJQUM1RSxJQUFNLEtBQUssR0FBRyxHQUFHLEtBQUssUUFBUSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDO0lBRTlDLDRDQUE0QztJQUM1QyxJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsSUFBSSxHQUFHLENBQUMsV0FBVyxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFO1FBQy9FLE9BQU8sR0FBRyxDQUFDO0tBQ1o7SUFFRCxJQUFJLE9BQW1CLENBQUM7SUFDeEIsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBQzdCLE9BQU8sR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BDLElBQU0sWUFBWSxHQUFHLDJCQUFlLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNsRSxJQUFJLFlBQVksRUFBRTtZQUNoQixPQUFPLEdBQUcsWUFBWSxDQUFDO1NBQ3hCO1FBRUQsbUVBQW1FO1FBQ25FLElBQUksT0FBTyxPQUFPLEtBQUssVUFBVSxFQUFF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QUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsQ0FBQyx1QkFBTSxPQUFPLEtBQUUsS0FBSyxPQUFBLElBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUNoRixDQUFDLEVBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleHRyYWN0RGVwZW5kZW5jeSB9IGZyb20gJy4uL2NvbW1vbi9jb3JlLmhlbHBlcnMnO1xuaW1wb3J0IHsgTkdfTU9DS1NfSU5URVJDRVBUT1JTIH0gZnJvbSAnLi4vY29tbW9uL2NvcmUudG9rZW5zJztcbmltcG9ydCB7IGlzTmdJbmplY3Rpb25Ub2tlbiB9IGZyb20gJy4uL2NvbW1vbi9mdW5jLmlzLW5nLWluamVjdGlvbi10b2tlbic7XG5pbXBvcnQgbmdNb2Nrc1VuaXZlcnNlIGZyb20gJy4uL2NvbW1vbi9uZy1tb2Nrcy11bml2ZXJzZSc7XG5cbmltcG9ydCBtb2NrU2VydmljZUhlbHBlciBmcm9tICcuL2hlbHBlcic7XG5pbXBvcnQgTW9ja1Byb3ZpZGVyIGZyb20gJy4vbW9jay1wcm92aWRlcic7XG5cbi8vIHRyaWVzIHRvIHJlc29sdmUgYSBwcm92aWRlciBiYXNlZCBvbiBjdXJyZW50IHVuaXZlcnNlIHN0YXRlLlxuZXhwb3J0IGRlZmF1bHQgKGRlZjogYW55LCByZXNvbHV0aW9uczogTWFwPGFueSwgYW55PiwgY2hhbmdlZD86IChmbGFnOiBib29sZWFuKSA9PiB2b2lkKSA9PiB7XG4gIGNvbnN0IHByb3ZpZGVyID0gdHlwZW9mIGRlZiA9PT0gJ29iamVjdCcgJiYgZGVmLnByb3ZpZGUgPyBkZWYucHJvdmlkZSA6IGRlZjtcbiAgY29uc3QgbXVsdGkgPSBkZWYgIT09IHByb3ZpZGVyICYmICEhZGVmLm11bHRpO1xuXG4gIC8vICB3ZSBzaG91bGRuJ3QgdG91Y2ggb3VyIHN5c3RlbSBwcm92aWRlcnMuXG4gIGlmICh0eXBlb2YgZGVmID09PSAnb2JqZWN0JyAmJiBkZWYudXNlRXhpc3RpbmcgJiYgZGVmLnVzZUV4aXN0aW5nLl9fbmdNb2Nrc1NraXApIHtcbiAgICByZXR1cm4gZGVmO1xuICB9XG5cbiAgbGV0IG1vY2tEZWY6IHR5cGVvZiBkZWY7XG4gIGlmIChyZXNvbHV0aW9ucy5oYXMocHJvdmlkZXIpKSB7XG4gICAgbW9ja0RlZiA9IHJlc29sdXRpb25zLmdldChwcm92aWRlcik7XG4gICAgY29uc3QgZXhpc3RpbmdNb2NrID0gbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLmdldChwcm92aWRlcik7XG4gICAgaWYgKGV4aXN0aW5nTW9jaykge1xuICAgICAgbW9ja0RlZiA9IGV4aXN0aW5nTW9jaztcbiAgICB9XG5cbiAgICAvLyBBIGNhc2Ugd2hlbiBhIHByb3ZpZGVyIGlzIGFjdHVhbGx5IGEgY29tcG9uZW50LCBkaXJlY3RpdmUsIHBpcGUuXG4gICAgaWYgKHR5cGVvZiBtb2NrRGVmID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBtb2NrRGVmID0ge1xuICAgICAgICBwcm92aWRlOiBwcm92aWRlcixcbiAgICAgICAgdXNlQ2xhc3M6IG1vY2tEZWYsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBtdWx0aSAmJiB0eXBlb2YgbW9ja0RlZiA9PT0gJ29iamVjdCcgPyB7IC4uLm1vY2tEZWYsIG11bHRpIH0gOiBtb2NrRGVmO1xuICB9XG5cbiAgLy8gIHdlIHNob3VsZG4ndCB0b3VjaCBleGNsdWRlZCBwcm92aWRlcnMuXG4gIGlmIChuZ01vY2tzVW5pdmVyc2UuYnVpbHRQcm92aWRlcnMuaGFzKHByb3ZpZGVyKSAmJiBuZ01vY2tzVW5pdmVyc2UuYnVpbHRQcm92aWRlcnMuZ2V0KHByb3ZpZGVyKSA9PT0gbnVsbCkge1xuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovXG4gICAgaWYgKGNoYW5nZWQpIHtcbiAgICAgIGNoYW5nZWQodHJ1ZSk7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChwcm92aWRlciAhPT0gZGVmICYmIGRlZi5kZXBzKSB7XG4gICAgZXh0cmFjdERlcGVuZGVuY3koZGVmLmRlcHMsIG5nTW9ja3NVbml2ZXJzZS5jb25maWcuZ2V0KCdkZXBzJykpO1xuICB9XG5cbiAgaWYgKFxuICAgIG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycy5oYXMoTkdfTU9DS1NfSU5URVJDRVBUT1JTKSAmJlxuICAgIG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycy5nZXQoTkdfTU9DS1NfSU5URVJDRVBUT1JTKSA9PT0gbnVsbCAmJlxuICAgIGlzTmdJbmplY3Rpb25Ub2tlbihwcm92aWRlcikgJiZcbiAgICBwcm92aWRlci50b1N0cmluZygpID09PSAnSW5qZWN0aW9uVG9rZW4gSFRUUF9JTlRFUkNFUFRPUlMnICYmXG4gICAgcHJvdmlkZXIgIT09IGRlZlxuICApIHtcbiAgICBpZiAoZGVmLnVzZUZhY3RvcnkgfHwgZGVmLnVzZVZhbHVlKSB7XG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqL1xuICAgICAgaWYgKGNoYW5nZWQpIHtcbiAgICAgICAgY2hhbmdlZCh0cnVlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgaW50ZXJjZXB0b3IgPSBkZWYudXNlRXhpc3RpbmcgfHwgZGVmLnVzZUNsYXNzO1xuICAgIGlmICghbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLmhhcyhpbnRlcmNlcHRvcikgfHwgbmdNb2Nrc1VuaXZlcnNlLmJ1aWx0UHJvdmlkZXJzLmdldChpbnRlcmNlcHRvcikgPT09IG51bGwpIHtcbiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovXG4gICAgICBpZiAoY2hhbmdlZCkge1xuICAgICAgICBjaGFuZ2VkKHRydWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgfVxuXG4gIC8vIFRoZW4gd2UgY2hlY2sgZGVjaXNpb25zIHdoZXRoZXIgd2Ugc2hvdWxkIGtlZXAgb3IgcmVwbGFjZSBhIGRlZi5cbiAgaWYgKG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycy5oYXMocHJvdmlkZXIpKSB7XG4gICAgbW9ja0RlZiA9IG5nTW9ja3NVbml2ZXJzZS5idWlsdFByb3ZpZGVycy5nZXQocHJvdmlkZXIpO1xuICAgIGlmIChtb2NrRGVmID09PSBwcm92aWRlcikge1xuICAgICAgbW9ja0RlZiA9IGRlZjtcbiAgICB9IGVsc2UgaWYgKG1vY2tEZWYgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbW9ja0RlZiA9IHtcbiAgICAgICAgcHJvdmlkZTogcHJvdmlkZXIsXG4gICAgICAgIHVzZVZhbHVlOiB1bmRlZmluZWQsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIGlmICghbW9ja0RlZiAmJiBuZ01vY2tzVW5pdmVyc2UuZmxhZ3MuaGFzKCdza2lwTW9jaycpKSB7XG4gICAgbmdNb2Nrc1VuaXZlcnNlLmNvbmZpZy5nZXQoJ2RlcHNTa2lwJyk/LmFkZChwcm92aWRlcik7XG4gICAgbW9ja0RlZiA9IGRlZjtcbiAgfVxuICBpZiAoIW1vY2tEZWYpIHtcbiAgICBtb2NrRGVmID0gTW9ja1Byb3ZpZGVyKGRlZik7XG4gIH1cbiAgLy8gaWYgcHJvdmlkZXIgaXMgYSB2YWx1ZSwgd2UgbmVlZCB0byBnbyB0aHJvdWdoIHRoZSB2YWx1ZSBhbmQgdG8gcmVwbGFjZSBhbGwgbW9jayBpbnN0YW5jZXMuXG4gIGlmIChwcm92aWRlciAhPT0gZGVmICYmIG1vY2tEZWYgJiYgbW9ja0RlZi51c2VWYWx1ZSkge1xuICAgIGNvbnN0IHVzZVZhbHVlID0gbW9ja1NlcnZpY2VIZWxwZXIucmVwbGFjZVdpdGhNb2Nrcyhtb2NrRGVmLnVzZVZhbHVlKTtcbiAgICBtb2NrRGVmID1cbiAgICAgIHVzZVZhbHVlID09PSBtb2NrRGVmLnVzZVZhbHVlXG4gICAgICAgID8gbW9ja0RlZlxuICAgICAgICA6IHtcbiAgICAgICAgICAgIC4uLm1vY2tEZWYsXG4gICAgICAgICAgICB1c2VWYWx1ZSxcbiAgICAgICAgICB9O1xuICB9XG5cbiAgaWYgKCFpc05nSW5qZWN0aW9uVG9rZW4ocHJvdmlkZXIpIHx8IGRlZiAhPT0gbW9ja0RlZikge1xuICAgIHJlc29sdXRpb25zLnNldChwcm92aWRlciwgbW9ja0RlZik7XG4gIH1cbiAgbGV0IGRpZmZlcnMgPSBmYWxzZTtcbiAgaWYgKGRlZiA9PT0gcHJvdmlkZXIgJiYgbW9ja0RlZiAhPT0gZGVmKSB7XG4gICAgZGlmZmVycyA9IHRydWU7XG4gIH0gZWxzZSBpZiAoXG4gICAgZGVmICE9PSBwcm92aWRlciAmJlxuICAgICghbW9ja0RlZiB8fFxuICAgICAgZGVmLnByb3ZpZGUgIT09IG1vY2tEZWYucHJvdmlkZSB8fFxuICAgICAgZGVmLnVzZVZhbHVlICE9PSBtb2NrRGVmLnVzZVZhbHVlIHx8XG4gICAgICBkZWYudXNlQ2xhc3MgIT09IG1vY2tEZWYudXNlQ2xhc3MgfHxcbiAgICAgIGRlZi51c2VFeGlzdGluZyAhPT0gbW9ja0RlZi51c2VFeGlzdGluZyB8fFxuICAgICAgZGVmLnVzZUZhY3RvcnkgIT09IG1vY2tEZWYudXNlRmFjdG9yeSB8fFxuICAgICAgZGVmLmRlcHMgIT09IG1vY2tEZWYuZGVwcylcbiAgKSB7XG4gICAgZGlmZmVycyA9IHRydWU7XG4gIH1cbiAgaWYgKGNoYW5nZWQgJiYgZGlmZmVycykge1xuICAgIGNoYW5nZWQodHJ1ZSk7XG4gIH1cblxuICAvLyBUb3VjaGluZyBvbmx5IHdoZW4gd2UgcmVhbGx5IHByb3ZpZGUgYSB2YWx1ZS5cbiAgaWYgKG1vY2tEZWYpIHtcbiAgICBuZ01vY2tzVW5pdmVyc2UudG91Y2hlcy5hZGQocHJvdmlkZXIpO1xuICB9XG5cbiAgcmV0dXJuIG11bHRpICYmIHR5cGVvZiBtb2NrRGVmID09PSAnb2JqZWN0JyA/IHsgLi4ubW9ja0RlZiwgbXVsdGkgfSA6IG1vY2tEZWY7XG59O1xuIl19