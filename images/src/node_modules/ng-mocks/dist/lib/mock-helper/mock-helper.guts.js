"use strict";
var __values = (this && this.__values) || function(o) {
    var s = typeof Symbol === "function" && Symbol.iterator, m = s && o[s], i = 0;
    if (m) return m.call(o);
    if (o && typeof o.length === "number") return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
    throw new TypeError(s ? "Object is not iterable." : "Symbol.iterator is not defined.");
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_helpers_1 = require("../common/core.helpers");
var core_reflect_1 = require("../common/core.reflect");
var func_is_ng_def_1 = require("../common/func.is-ng-def");
var func_is_ng_injection_token_1 = require("../common/func.is-ng-injection-token");
var func_is_ng_module_def_with_providers_1 = require("../common/func.is-ng-module-def-with-providers");
var mock_component_1 = require("../mock-component/mock-component");
var mock_directive_1 = require("../mock-directive/mock-directive");
var mock_module_1 = require("../mock-module/mock-module");
var mock_pipe_1 = require("../mock-pipe/mock-pipe");
var mock_provider_1 = require("../mock-service/mock-provider");
exports.default = (function (keep, mock, exclude) {
    var e_1, _a, e_2, _b, e_3, _c, e_4, _d, e_5, _e;
    if (mock === void 0) { mock = null; }
    if (exclude === void 0) { exclude = null; }
    var declarations = [];
    var imports = [];
    var providers = [];
    var keepFlat = [];
    try {
        for (var _f = __values(keep ? core_helpers_1.flatten(keep) : []), _g = _f.next(); !_g.done; _g = _f.next()) {
            var def = _g.value;
            if (keepFlat.indexOf(def) === -1) {
                keepFlat.push(def);
            }
        }
    }
    catch (e_1_1) { e_1 = { error: e_1_1 }; }
    finally {
        try {
            if (_g && !_g.done && (_a = _f.return)) _a.call(_f);
        }
        finally { if (e_1) throw e_1.error; }
    }
    var mockFlat = [];
    try {
        for (var _h = __values(mock ? core_helpers_1.flatten(mock) : []), _j = _h.next(); !_j.done; _j = _h.next()) {
            var def = _j.value;
            if (mockFlat.indexOf(def) === -1) {
                mockFlat.push(def);
            }
        }
    }
    catch (e_2_1) { e_2 = { error: e_2_1 }; }
    finally {
        try {
            if (_j && !_j.done && (_b = _h.return)) _b.call(_h);
        }
        finally { if (e_2) throw e_2.error; }
    }
    var excludeFlat = [];
    try {
        for (var _k = __values(exclude ? core_helpers_1.flatten(exclude) : []), _l = _k.next(); !_l.done; _l = _k.next()) {
            var def = _l.value;
            if (excludeFlat.indexOf(def) === -1) {
                excludeFlat.push(def);
            }
        }
    }
    catch (e_3_1) { e_3 = { error: e_3_1 }; }
    finally {
        try {
            if (_l && !_l.done && (_c = _k.return)) _c.call(_k);
        }
        finally { if (e_3) throw e_3.error; }
    }
    var skip = [];
    var resolveProvider = function (def) {
        var provider = typeof def === 'object' && def.provide ? def.provide : def;
        if (skip.indexOf(provider) === -1) {
            skip.push(provider);
        }
        if (excludeFlat.indexOf(provider) !== -1) {
            return;
        }
        var providerDef = keepFlat.indexOf(provider) === -1 ? mock_provider_1.default(def) : def;
        if (providerDef) {
            providers.push(providerDef);
        }
    };
    var resolve = function (def, skipDestruction) {
        var e_6, _a, e_7, _b;
        if (skipDestruction === void 0) { skipDestruction = true; }
        if (!def) {
            return;
        }
        if (func_is_ng_module_def_with_providers_1.isNgModuleDefWithProviders(def)) {
            if (skip.indexOf(def.ngModule) !== -1) {
                return;
            }
            skip.push(def.ngModule);
            if (excludeFlat.indexOf(def.ngModule) !== -1) {
                return;
            }
            imports.push(keepFlat.indexOf(def.ngModule) === -1 ? mock_module_1.MockModule(def) : def);
            return;
        }
        if (func_is_ng_def_1.isNgDef(def, 'm') && keepFlat.indexOf(def) !== -1) {
            if (skip.indexOf(def) !== -1) {
                return;
            }
            skip.push(def);
            if (excludeFlat.indexOf(def) !== -1) {
                return;
            }
            imports.push(def);
            return;
        }
        if (func_is_ng_def_1.isNgDef(def, 'm') && skipDestruction && keepFlat.indexOf(def) === -1) {
            if (skip.indexOf(def) !== -1) {
                return;
            }
            skip.push(def);
            if (excludeFlat.indexOf(def) !== -1) {
                return;
            }
            imports.push(mock_module_1.MockModule(def));
            return;
        }
        if (func_is_ng_def_1.isNgDef(def, 'm') && keepFlat.indexOf(def) === -1) {
            /* istanbul ignore if: unreachable due to the skipDestruction flag */
            if (skip.indexOf(def) !== -1) {
                return;
            }
            skip.push(def);
            if (excludeFlat.indexOf(def) !== -1) {
                return;
            }
            var meta = void 0;
            try {
                meta = core_reflect_1.ngModuleResolver.resolve(def);
            }
            catch (e) {
                /* istanbul ignore next */
                throw new Error('ng-mocks is not in JIT mode and cannot resolve declarations');
            }
            try {
                for (var _c = __values(core_helpers_1.flatten([meta.declarations, meta.imports])), _d = _c.next(); !_d.done; _d = _c.next()) {
                    var toMock = _d.value;
                    resolve(toMock);
                }
            }
            catch (e_6_1) { e_6 = { error: e_6_1 }; }
            finally {
                try {
                    if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
                }
                finally { if (e_6) throw e_6.error; }
            }
            try {
                for (var _e = __values(meta.providers ? core_helpers_1.flatten(meta.providers) : []), _f = _e.next(); !_f.done; _f = _e.next()) {
                    var toMock = _f.value;
                    resolveProvider(toMock);
                }
            }
            catch (e_7_1) { e_7 = { error: e_7_1 }; }
            finally {
                try {
                    if (_f && !_f.done && (_b = _e.return)) _b.call(_e);
                }
                finally { if (e_7) throw e_7.error; }
            }
            return;
        }
        if (func_is_ng_def_1.isNgDef(def, 'c')) {
            if (skip.indexOf(def) !== -1) {
                return;
            }
            skip.push(def);
            if (excludeFlat.indexOf(def) !== -1) {
                return;
            }
            declarations.push(keepFlat.indexOf(def) === -1 ? mock_component_1.MockComponent(def) : def);
            return;
        }
        if (func_is_ng_def_1.isNgDef(def, 'd')) {
            if (skip.indexOf(def) !== -1) {
                return;
            }
            skip.push(def);
            if (excludeFlat.indexOf(def) !== -1) {
                return;
            }
            declarations.push(keepFlat.indexOf(def) === -1 ? mock_directive_1.MockDirective(def) : def);
            return;
        }
        if (func_is_ng_def_1.isNgDef(def, 'p')) {
            if (skip.indexOf(def) !== -1) {
                return;
            }
            skip.push(def);
            if (excludeFlat.indexOf(def) !== -1) {
                return;
            }
            declarations.push(keepFlat.indexOf(def) === -1 ? mock_pipe_1.MockPipe(def) : def);
            return;
        }
        resolveProvider(def);
    };
    try {
        for (var mockFlat_1 = __values(mockFlat), mockFlat_1_1 = mockFlat_1.next(); !mockFlat_1_1.done; mockFlat_1_1 = mockFlat_1.next()) {
            var def = mockFlat_1_1.value;
            resolve(def, false);
        }
    }
    catch (e_4_1) { e_4 = { error: e_4_1 }; }
    finally {
        try {
            if (mockFlat_1_1 && !mockFlat_1_1.done && (_d = mockFlat_1.return)) _d.call(mockFlat_1);
        }
        finally { if (e_4) throw e_4.error; }
    }
    try {
        for (var keepFlat_1 = __values(keepFlat), keepFlat_1_1 = keepFlat_1.next(); !keepFlat_1_1.done; keepFlat_1_1 = keepFlat_1.next()) {
            var def = keepFlat_1_1.value;
            if (skip.indexOf(def) !== -1) {
                continue;
            }
            if (excludeFlat.indexOf(def) !== -1) {
                continue;
            }
            if (func_is_ng_def_1.isNgDef(def, 'm')) {
                imports.push(def);
                continue;
            }
            if (func_is_ng_def_1.isNgDef(def, 'c')) {
                declarations.push(def);
                continue;
            }
            if (func_is_ng_def_1.isNgDef(def, 'd')) {
                declarations.push(def);
                continue;
            }
            if (func_is_ng_def_1.isNgDef(def, 'p')) {
                declarations.push(def);
                providers.push(def);
                continue;
            }
            if (func_is_ng_injection_token_1.isNgInjectionToken(def)) {
                continue;
            }
            providers.push(def);
        }
    }
    catch (e_5_1) { e_5 = { error: e_5_1 }; }
    finally {
        try {
            if (keepFlat_1_1 && !keepFlat_1_1.done && (_e = keepFlat_1.return)) _e.call(keepFlat_1);
        }
        finally { if (e_5) throw e_5.error; }
    }
    return {
        declarations: declarations,
        imports: imports,
        providers: providers,
    };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9jay1oZWxwZXIuZ3V0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9tb2NrLWhlbHBlci9tb2NrLWhlbHBlci5ndXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFHQSx1REFBaUQ7QUFDakQsdURBQTBEO0FBQzFELDJEQUFtRDtBQUNuRCxtRkFBMEU7QUFDMUUsdUdBQTRGO0FBQzVGLG1FQUFpRTtBQUNqRSxtRUFBaUU7QUFDakUsMERBQXdEO0FBQ3hELG9EQUFrRDtBQUNsRCwrREFBeUQ7QUFFekQsbUJBQWUsVUFBQyxJQUFTLEVBQUUsSUFBZ0IsRUFBRSxPQUFtQjs7SUFBckMscUJBQUEsRUFBQSxXQUFnQjtJQUFFLHdCQUFBLEVBQUEsY0FBbUI7SUFDOUQsSUFBTSxZQUFZLEdBQVUsRUFBRSxDQUFDO0lBQy9CLElBQU0sT0FBTyxHQUFVLEVBQUUsQ0FBQztJQUMxQixJQUFNLFNBQVMsR0FBVSxFQUFFLENBQUM7SUFFNUIsSUFBTSxRQUFRLEdBQVUsRUFBRSxDQUFDOztRQUMzQixLQUFrQixJQUFBLEtBQUEsU0FBQSxJQUFJLENBQUMsQ0FBQyxDQUFDLHNCQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQSxnQkFBQSw0QkFBRTtZQUF4QyxJQUFNLEdBQUcsV0FBQTtZQUNaLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtnQkFDaEMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNwQjtTQUNGOzs7Ozs7Ozs7SUFFRCxJQUFNLFFBQVEsR0FBVSxFQUFFLENBQUM7O1FBQzNCLEtBQWtCLElBQUEsS0FBQSxTQUFBLElBQUksQ0FBQyxDQUFDLENBQUMsc0JBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBLGdCQUFBLDRCQUFFO1lBQXhDLElBQU0sR0FBRyxXQUFB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LHFCQUFBO1lBQ1osSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO2dCQUM1QixTQUFTO2FBQ1Y7WUFDRCxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ25DLFNBQVM7YUFDVjtZQUVELElBQUksd0JBQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2xCLFNBQVM7YUFDVjtZQUVELElBQUksd0JBQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3ZCLFNBQVM7YUFDVjtZQUVELElBQUksd0JBQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3ZCLFNBQVM7YUFDVjtZQUVELElBQUksd0JBQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3ZCLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3BCLFNBQVM7YUFDVjtZQUVELElBQUksK0NBQWtCLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQzNCLFNBQVM7YUFDVjtZQUNELFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDckI7Ozs7Ozs7OztJQUVELE9BQU87UUFDTCxZQUFZLGNBQUE7UUFDWixPQUFPLFNBQUE7UUFDUCxTQUFTLFdBQUE7S0FDVixDQUFDO0FBQ0osQ0FBQyxFQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29yZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbXBpbGVyJztcbmltcG9ydCB7IFRlc3RNb2R1bGVNZXRhZGF0YSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvdGVzdGluZyc7XG5cbmltcG9ydCB7IGZsYXR0ZW4gfSBmcm9tICcuLi9jb21tb24vY29yZS5oZWxwZXJzJztcbmltcG9ydCB7IG5nTW9kdWxlUmVzb2x2ZXIgfSBmcm9tICcuLi9jb21tb24vY29yZS5yZWZsZWN0JztcbmltcG9ydCB7IGlzTmdEZWYgfSBmcm9tICcuLi9jb21tb24vZnVuYy5pcy1uZy1kZWYnO1xuaW1wb3J0IHsgaXNOZ0luamVjdGlvblRva2VuIH0gZnJvbSAnLi4vY29tbW9uL2Z1bmMuaXMtbmctaW5qZWN0aW9uLXRva2VuJztcbmltcG9ydCB7IGlzTmdNb2R1bGVEZWZXaXRoUHJvdmlkZXJzIH0gZnJvbSAnLi4vY29tbW9uL2Z1bmMuaXMtbmctbW9kdWxlLWRlZi13aXRoLXByb3ZpZGVycyc7XG5pbXBvcnQgeyBNb2NrQ29tcG9uZW50IH0gZnJvbSAnLi4vbW9jay1jb21wb25lbnQvbW9jay1jb21wb25lbnQnO1xuaW1wb3J0IHsgTW9ja0RpcmVjdGl2ZSB9IGZyb20gJy4uL21vY2stZGlyZWN0aXZlL21vY2stZGlyZWN0aXZlJztcbmltcG9ydCB7IE1vY2tNb2R1bGUgfSBmcm9tICcuLi9tb2NrLW1vZHVsZS9tb2NrLW1vZHVsZSc7XG5pbXBvcnQgeyBNb2NrUGlwZSB9IGZyb20gJy4uL21vY2stcGlwZS9tb2NrLXBpcGUnO1xuaW1wb3J0IE1vY2tQcm92aWRlciBmcm9tICcuLi9tb2NrLXNlcnZpY2UvbW9jay1wcm92aWRlcic7XG5cbmV4cG9ydCBkZWZhdWx0IChrZWVwOiBhbnksIG1vY2s6IGFueSA9IG51bGwsIGV4Y2x1ZGU6IGFueSA9IG51bGwpOiBUZXN0TW9kdWxlTWV0YWRhdGEgPT4ge1xuICBjb25zdCBkZWNsYXJhdGlvbnM6IGFueVtdID0gW107XG4gIGNvbnN0IGltcG9ydHM6IGFueVtdID0gW107XG4gIGNvbnN0IHByb3ZpZGVyczogYW55W10gPSBbXTtcblxuICBjb25zdCBrZWVwRmxhdDogYW55W10gPSBbXTtcbiAgZm9yIChjb25zdCBkZWYgb2Yga2VlcCA/IGZsYXR0ZW4oa2VlcCkgOiBbXSkge1xuICAgIGlmIChrZWVwRmxhdC5pbmRleE9mKGRlZikgPT09IC0xKSB7XG4gICAgICBrZWVwRmxhdC5wdXNoKGRlZik7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgbW9ja0ZsYXQ6IGFueVtdID0gW107XG4gIGZvciAoY29uc3QgZGVmIG9mIG1vY2sgPyBmbGF0dGVuKG1vY2spIDogW10pIHtcbiAgICBpZiAobW9ja0ZsYXQuaW5kZXhPZihkZWYpID09PSAtMSkge1xuICAgICAgbW9ja0ZsYXQucHVzaChkZWYpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGV4Y2x1ZGVGbGF0OiBhbnlbXSA9IFtdO1xuICBmb3IgKGNvbnN0IGRlZiBvZiBleGNsdWRlID8gZmxhdHRlbihleGNsdWRlKSA6IFtdKSB7XG4gICAgaWYgKGV4Y2x1ZGVGbGF0LmluZGV4T2YoZGVmKSA9PT0gLTEpIHtcbiAgICAgIGV4Y2x1ZGVGbGF0LnB1c2goZGVmKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBza2lwOiBhbnlbXSA9IFtdO1xuXG4gIGNvbnN0IHJlc29sdmVQcm92aWRlciA9IChkZWY6IGFueSk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IHByb3ZpZGVyID0gdHlwZW9mIGRlZiA9PT0gJ29iamVjdCcgJiYgZGVmLnByb3ZpZGUgPyBkZWYucHJvdmlkZSA6IGRlZjtcbiAgICBpZiAoc2tpcC5pbmRleE9mKHByb3ZpZGVyKSA9PT0gLTEpIHtcbiAgICAgIHNraXAucHVzaChwcm92aWRlcik7XG4gICAgfVxuICAgIGlmIChleGNsdWRlRmxhdC5pbmRleE9mKHByb3ZpZGVyKSAhPT0gLTEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwcm92aWRlckRlZiA9IGtlZXBGbGF0LmluZGV4T2YocHJvdmlkZXIpID09PSAtMSA/IE1vY2tQcm92aWRlcihkZWYpIDogZGVmO1xuICAgIGlmIChwcm92aWRlckRlZikge1xuICAgICAgcHJvdmlkZXJzLnB1c2gocHJvdmlkZXJEZWYpO1xuICAgIH1cbiAgfTtcblxuICBjb25zdCByZXNvbHZlID0gKGRlZjogYW55LCBza2lwRGVzdHJ1Y3Rpb24gPSB0cnVlKTogdm9pZCA9PiB7XG4gICAgaWYgKCFkZWYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNOZ01vZHVsZURlZldpdGhQcm92aWRlcnMoZGVmKSkge1xuICAgICAgaWYgKHNraXAuaW5kZXhPZihkZWYubmdNb2R1bGUpICE9PSAtMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBza2lwLnB1c2goZGVmLm5nTW9kdWxlKTtcbiAgICAgIGlmIChleGNsdWRlRmxhdC5pbmRleE9mKGRlZi5uZ01vZHVsZSkgIT09IC0xKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaW1wb3J0cy5wdXNoKGtlZXBGbGF0LmluZGV4T2YoZGVmLm5nTW9kdWxlKSA9PT0gLTEgPyBNb2NrTW9kdWxlKGRlZikgOiBkZWYpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChpc05nRGVmKGRlZiwgJ20nKSAmJiBrZWVwRmxhdC5pbmRleE9mKGRlZikgIT09IC0xKSB7XG4gICAgICBpZiAoc2tpcC5pbmRleE9mKGRlZikgIT09IC0xKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHNraXAucHVzaChkZWYpO1xuICAgICAgaWYgKGV4Y2x1ZGVGbGF0LmluZGV4T2YoZGVmKSAhPT0gLTEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpbXBvcnRzLnB1c2goZGVmKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNOZ0RlZihkZWYsICdtJykgJiYgc2tpcERlc3RydWN0aW9uICYmIGtlZXBGbGF0LmluZGV4T2YoZGVmKSA9PT0gLTEpIHtcbiAgICAgIGlmIChza2lwLmluZGV4T2YoZGVmKSAhPT0gLTEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgc2tpcC5wdXNoKGRlZik7XG4gICAgICBpZiAoZXhjbHVkZUZsYXQuaW5kZXhPZihkZWYpICE9PSAtMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGltcG9ydHMucHVzaChNb2NrTW9kdWxlKGRlZikpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChpc05nRGVmKGRlZiwgJ20nKSAmJiBrZWVwRmxhdC5pbmRleE9mKGRlZikgPT09IC0xKSB7XG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWY6IHVucmVhY2hhYmxlIGR1ZSB0byB0aGUgc2tpcERlc3RydWN0aW9uIGZsYWcgKi9cbiAgICAgIGlmIChza2lwLmluZGV4T2YoZGVmKSAhPT0gLTEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgc2tpcC5wdXNoKGRlZik7XG4gICAgICBpZiAoZXhjbHVkZUZsYXQuaW5kZXhPZihkZWYpICE9PSAtMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxldCBtZXRhOiBjb3JlLk5nTW9kdWxlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbWV0YSA9IG5nTW9kdWxlUmVzb2x2ZXIucmVzb2x2ZShkZWYpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25nLW1vY2tzIGlzIG5vdCBpbiBKSVQgbW9kZSBhbmQgY2Fubm90IHJlc29sdmUgZGVjbGFyYXRpb25zJyk7XG4gICAgICB9XG5cbiAgICAgIGZvciAoY29uc3QgdG9Nb2NrIG9mIGZsYXR0ZW4oW21ldGEuZGVjbGFyYXRpb25zLCBtZXRhLmltcG9ydHNdKSkge1xuICAgICAgICByZXNvbHZlKHRvTW9jayk7XG4gICAgICB9XG4gICAgICBmb3IgKGNvbnN0IHRvTW9jayBvZiBtZXRhLnByb3ZpZGVycyA/IGZsYXR0ZW4obWV0YS5wcm92aWRlcnMpIDogW10pIHtcbiAgICAgICAgcmVzb2x2ZVByb3ZpZGVyKHRvTW9jayk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGlzTmdEZWYoZGVmLCAnYycpKSB7XG4gICAgICBpZiAoc2tpcC5pbmRleE9mKGRlZikgIT09IC0xKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHNraXAucHVzaChkZWYpO1xuICAgICAgaWYgKGV4Y2x1ZGVGbGF0LmluZGV4T2YoZGVmKSAhPT0gLTEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBkZWNsYXJhdGlvbnMucHVzaChrZWVwRmxhdC5pbmRleE9mKGRlZikgPT09IC0xID8gTW9ja0NvbXBvbmVudChkZWYpIDogZGVmKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNOZ0RlZihkZWYsICdkJykpIHtcbiAgICAgIGlmIChza2lwLmluZGV4T2YoZGVmKSAhPT0gLTEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgc2tpcC5wdXNoKGRlZik7XG4gICAgICBpZiAoZXhjbHVkZUZsYXQuaW5kZXhPZihkZWYpICE9PSAtMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGRlY2xhcmF0aW9ucy5wdXNoKGtlZXBGbGF0LmluZGV4T2YoZGVmKSA9PT0gLTEgPyBNb2NrRGlyZWN0aXZlKGRlZikgOiBkZWYpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChpc05nRGVmKGRlZiwgJ3AnKSkge1xuICAgICAgaWYgKHNraXAuaW5kZXhPZihkZWYpICE9PSAtMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBza2lwLnB1c2goZGVmKTtcbiAgICAgIGlmIChleGNsdWRlRmxhdC5pbmRleE9mKGRlZikgIT09IC0xKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgZGVjbGFyYXRpb25zLnB1c2goa2VlcEZsYXQuaW5kZXhPZihkZWYpID09PSAtMSA/IE1vY2tQaXBlKGRlZikgOiBkZWYpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHJlc29sdmVQcm92aWRlcihkZWYpO1xuICB9O1xuXG4gIGZvciAoY29uc3QgZGVmIG9mIG1vY2tGbGF0KSB7XG4gICAgcmVzb2x2ZShkZWYsIGZhbHNlKTtcbiAgfVxuXG4gIGZvciAoY29uc3QgZGVmIG9mIGtlZXBGbGF0KSB7XG4gICAgaWYgKHNraXAuaW5kZXhPZihkZWYpICE9PSAtMSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGlmIChleGNsdWRlRmxhdC5pbmRleE9mKGRlZikgIT09IC0xKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoaXNOZ0RlZihkZWYsICdtJykpIHtcbiAgICAgIGltcG9ydHMucHVzaChkZWYpO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKGlzTmdEZWYoZGVmLCAnYycpKSB7XG4gICAgICBkZWNsYXJhdGlvbnMucHVzaChkZWYpO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKGlzTmdEZWYoZGVmLCAnZCcpKSB7XG4gICAgICBkZWNsYXJhdGlvbnMucHVzaChkZWYpO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKGlzTmdEZWYoZGVmLCAncCcpKSB7XG4gICAgICBkZWNsYXJhdGlvbnMucHVzaChkZWYpO1xuICAgICAgcHJvdmlkZXJzLnB1c2goZGVmKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmIChpc05nSW5qZWN0aW9uVG9rZW4oZGVmKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIHByb3ZpZGVycy5wdXNoKGRlZik7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGRlY2xhcmF0aW9ucyxcbiAgICBpbXBvcnRzLFxuICAgIHByb3ZpZGVycyxcbiAgfTtcbn07XG4iXX0=