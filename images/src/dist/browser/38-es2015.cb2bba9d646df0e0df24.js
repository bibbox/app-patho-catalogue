(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{"SyZ+":function(t,e,i){"use strict";i.r(e),i.d(e,"BitstreamPageModule",(function(){return A}));var a=i("SVse"),n=i("PCNd"),r=i("iInd"),s=i("lJxs"),o=i("eIep"),l=i("5+tZ"),d=i("itXk"),m=i("LRne"),c=i("QOHy"),p=i("JN36"),h=i("LvDl"),u=i("1QIV"),b=i("87+M"),f=i("J3qs"),F=i("/eM4"),g=i("MEmd"),v=i("8Y7J"),I=i("TSSN"),y=i("PCBh"),w=i("lI3o"),C=i("B7d6"),j=i("O/5o"),O=i("/lGE"),M=i("hqmO"),S=i("s7LF"),x=i("HZwm"),E=i("Frqi"),N=i("t8/W");function B(t,e){if(1&t){const t=v["\u0275\u0275getCurrentView"]();v["\u0275\u0275elementStart"](0,"div",5),v["\u0275\u0275text"](1,"\n      "),v["\u0275\u0275elementStart"](2,"div",6),v["\u0275\u0275text"](3,"\n        "),v["\u0275\u0275element"](4,"ds-thumbnail",7),v["\u0275\u0275text"](5,"\n      "),v["\u0275\u0275elementEnd"](),v["\u0275\u0275text"](6,"\n      "),v["\u0275\u0275elementStart"](7,"div",8),v["\u0275\u0275text"](8,"\n        "),v["\u0275\u0275elementStart"](9,"div",2),v["\u0275\u0275text"](10,"\n          "),v["\u0275\u0275elementStart"](11,"div",5),v["\u0275\u0275text"](12,"\n            "),v["\u0275\u0275elementStart"](13,"div",9),v["\u0275\u0275text"](14,"\n              "),v["\u0275\u0275elementStart"](15,"h3"),v["\u0275\u0275text"](16),v["\u0275\u0275elementStart"](17,"span",10),v["\u0275\u0275text"](18),v["\u0275\u0275pipe"](19,"dsFileSize"),v["\u0275\u0275elementEnd"](),v["\u0275\u0275elementEnd"](),v["\u0275\u0275text"](20,"\n            "),v["\u0275\u0275elementEnd"](),v["\u0275\u0275text"](21,"\n          "),v["\u0275\u0275elementEnd"](),v["\u0275\u0275text"](22,"\n        "),v["\u0275\u0275elementEnd"](),v["\u0275\u0275text"](23,"\n        "),v["\u0275\u0275elementStart"](24,"ds-form",11),v["\u0275\u0275listener"]("submitForm",(function(){return v["\u0275\u0275restoreView"](t),v["\u0275\u0275nextContext"](3).onSubmit()}))("cancel",(function(){return v["\u0275\u0275restoreView"](t),v["\u0275\u0275nextContext"](3).onCancel()}))("dfChange",(function(e){return v["\u0275\u0275restoreView"](t),v["\u0275\u0275nextContext"](3).onChange(e)})),v["\u0275\u0275elementEnd"](),v["\u0275\u0275text"](25,"\n      "),v["\u0275\u0275elementEnd"](),v["\u0275\u0275text"](26,"\n    "),v["\u0275\u0275elementEnd"]()}if(2&t){const t=v["\u0275\u0275nextContext"](2).ngVar,e=v["\u0275\u0275nextContext"]();v["\u0275\u0275advance"](4),v["\u0275\u0275property"]("thumbnail",null==t?null:t.payload),v["\u0275\u0275advance"](12),v["\u0275\u0275textInterpolate1"]("",null==t||null==t.payload?null:t.payload.name," "),v["\u0275\u0275advance"](2),v["\u0275\u0275textInterpolate1"]("(",v["\u0275\u0275pipeBind1"](19,8,null==t||null==t.payload?null:t.payload.sizeBytes),")"),v["\u0275\u0275advance"](6),v["\u0275\u0275property"]("formId","edit-bitstream-form-id")("formGroup",e.formGroup)("formModel",e.formModel)("formLayout",e.formLayout)("submitLabel","form.save")}}function L(t,e){1&t&&(v["\u0275\u0275element"](0,"ds-error",12),v["\u0275\u0275pipe"](1,"translate")),2&t&&v["\u0275\u0275propertyInterpolate"]("message",v["\u0275\u0275pipeBind1"](1,1,"error.bitstream"))}function T(t,e){1&t&&(v["\u0275\u0275element"](0,"ds-loading",12),v["\u0275\u0275pipe"](1,"translate")),2&t&&v["\u0275\u0275propertyInterpolate"]("message",v["\u0275\u0275pipeBind1"](1,1,"loading.bitstream"))}function P(t,e){if(1&t&&(v["\u0275\u0275elementStart"](0,"div",2),v["\u0275\u0275text"](1,"\n    "),v["\u0275\u0275template"](2,B,27,10,"div",3),v["\u0275\u0275text"](3,"\n    "),v["\u0275\u0275template"](4,L,2,3,"ds-error",4),v["\u0275\u0275text"](5,"\n    "),v["\u0275\u0275template"](6,T,2,3,"ds-loading",4),v["\u0275\u0275text"](7,"\n  "),v["\u0275\u0275elementEnd"]()),2&t){const t=e.ngVar,i=v["\u0275\u0275nextContext"]().ngVar;v["\u0275\u0275advance"](2),v["\u0275\u0275property"]("ngIf",(null==i?null:i.hasSucceeded)&&(null==t?null:t.hasSucceeded)),v["\u0275\u0275advance"](2),v["\u0275\u0275property"]("ngIf",null==i?null:i.hasFailed),v["\u0275\u0275advance"](2),v["\u0275\u0275property"]("ngIf",!i||!t||(null==i?null:i.isLoading)||(null==t?null:t.isLoading))}}function V(t,e){if(1&t&&(v["\u0275\u0275elementContainerStart"](0),v["\u0275\u0275text"](1,"\n  "),v["\u0275\u0275template"](2,P,8,3,"div",1),v["\u0275\u0275pipe"](3,"async"),v["\u0275\u0275text"](4,"\n"),v["\u0275\u0275elementContainerEnd"]()),2&t){const t=v["\u0275\u0275nextContext"]();v["\u0275\u0275advance"](2),v["\u0275\u0275property"]("ngVar",v["\u0275\u0275pipeBind1"](3,1,t.bitstreamFormatsRD$))}}let k=(()=>{class t{constructor(t,e,i,a,n,r,s,o){this.route=t,this.router=e,this.location=i,this.formService=a,this.translate=n,this.bitstreamService=r,this.notificationsService=s,this.bitstreamFormatService=o,this.KEY_PREFIX="bitstream.edit.form.",this.LABEL_KEY_SUFFIX=".label",this.HINT_KEY_SUFFIX=".hint",this.NOTIFICATIONS_PREFIX="bitstream.edit.notifications.",this.findAllOptions={elementsPerPage:9999},this.fileNameModel=new c.I({id:"fileName",name:"fileName",required:!0,validators:{required:null},errorMessages:{required:"You must provide a file name for the bitstream"}}),this.primaryBitstreamModel=new p.b({id:"primaryBitstream",name:"primaryBitstream"}),this.descriptionModel=new c.O({id:"description",name:"description",rows:10}),this.embargoModel=new c.I({id:"embargo",name:"embargo",disabled:!0}),this.selectedFormatModel=new c.M({id:"selectedFormat",name:"selectedFormat"}),this.newFormatModel=new c.I({id:"newFormat",name:"newFormat"}),this.inputModels=[this.fileNameModel,this.primaryBitstreamModel,this.descriptionModel,this.embargoModel,this.selectedFormatModel,this.newFormatModel],this.formModel=[new c.C({id:"fileNamePrimaryContainer",group:[this.fileNameModel,this.primaryBitstreamModel]}),new c.C({id:"descriptionContainer",group:[this.descriptionModel]}),new c.C({id:"embargoContainer",group:[this.embargoModel]}),new c.C({id:"formatContainer",group:[this.selectedFormatModel,this.newFormatModel]})],this.newFormatBaseLayout="col col-sm-6 d-inline-block",this.formLayout={fileName:{grid:{host:"col col-sm-8 d-inline-block"}},primaryBitstream:{grid:{host:"col col-sm-4 d-inline-block switch"}},description:{grid:{host:"col-12 d-inline-block"}},embargo:{grid:{host:"col-12 d-inline-block"}},selectedFormat:{grid:{host:"col col-sm-6 d-inline-block"}},newFormat:{grid:{host:this.newFormatBaseLayout+" invisible"}},fileNamePrimaryContainer:{grid:{host:"row position-relative"}},descriptionContainer:{grid:{host:"row"}},embargoContainer:{grid:{host:"row"}},formatContainer:{grid:{host:"row"}}},this.subs=[]}ngOnInit(){this.formGroup=this.formService.createFormGroup(this.formModel),this.itemId=this.route.snapshot.queryParams.itemId,this.entityType=this.route.snapshot.queryParams.entityType,this.bitstreamRD$=this.route.data.pipe(Object(s.a)(t=>t.bitstream)),this.bitstreamFormatsRD$=this.bitstreamFormatService.findAll(this.findAllOptions);const t=this.bitstreamRD$.pipe(Object(u.i)(),Object(u.o)()),e=this.bitstreamFormatsRD$.pipe(Object(u.i)(),Object(u.o)());this.subs.push(Object(d.a)(t,e).subscribe(([t,e])=>{this.bitstream=t,this.formats=e.page,this.updateFormatModel(),this.updateForm(this.bitstream)})),this.updateFieldTranslations(),this.subs.push(this.translate.onLangChange.subscribe(()=>{this.updateFieldTranslations()}))}updateForm(t){this.formGroup.patchValue({fileNamePrimaryContainer:{fileName:t.name,primaryBitstream:!1},descriptionContainer:{description:t.firstMetadataValue("dc.description")},formatContainer:{newFormat:Object(f.b)(t.firstMetadata("dc.format"))?t.firstMetadata("dc.format").value:void 0}}),this.bitstream.format.pipe(Object(u.d)()).subscribe(t=>{this.originalFormat=t,this.formGroup.patchValue({formatContainer:{selectedFormat:t.id}}),this.updateNewFormatLayout(t.id)})}updateFormatModel(){this.selectedFormatModel.options=this.formats.map(t=>Object.assign({value:t.id,label:this.isUnknownFormat(t.id)?this.translate.instant(this.KEY_PREFIX+"selectedFormat.unknown"):t.shortDescription}))}updateNewFormatLayout(t){this.formLayout.newFormat.grid.host=this.isUnknownFormat(t)?this.newFormatBaseLayout:this.newFormatBaseLayout+" invisible"}isUnknownFormat(t){const e=this.formats.find(e=>e.id===t);return Object(f.b)(e)&&e.supportLevel===b.a.Unknown}updateFieldTranslations(){this.inputModels.forEach(t=>{this.updateFieldTranslation(t)})}updateFieldTranslation(t){t.label=this.translate.instant(this.KEY_PREFIX+t.id+this.LABEL_KEY_SUFFIX),t.id!==this.primaryBitstreamModel.id&&(t.hint=this.translate.instant(this.KEY_PREFIX+t.id+this.HINT_KEY_SUFFIX))}onChange(t){const e=t.model;e.id===this.selectedFormatModel.id&&this.updateNewFormatLayout(e.value)}onSubmit(){const t=this.formGroup.getRawValue(),e=this.formToBitstream(t),i=this.formats.find(e=>e.id===t.formatContainer.selectedFormat);let a;a=i.id!==this.originalFormat.id?this.bitstreamService.updateFormat(this.bitstream,i).pipe(Object(u.g)(),Object(s.a)(t=>{if(!Object(f.b)(t)||!t.hasFailed)return t.payload;this.notificationsService.error(this.translate.instant(this.NOTIFICATIONS_PREFIX+"error.format.title"),t.errorMessage)})):Object(m.a)(this.bitstream),a.pipe(Object(o.a)(()=>this.bitstreamService.update(e).pipe(Object(u.j)()))).subscribe(()=>{this.bitstreamService.commitUpdates(),this.notificationsService.success(this.translate.instant(this.NOTIFICATIONS_PREFIX+"saved.title"),this.translate.instant(this.NOTIFICATIONS_PREFIX+"saved.content")),this.navigateToItemEditBitstreams()})}formToBitstream(t){const e=Object(h.cloneDeep)(this.bitstream),i=e.metadata;return F.a.setFirstValue(i,"dc.title",t.fileNamePrimaryContainer.fileName),F.a.setFirstValue(i,"dc.description",t.descriptionContainer.description),Object(f.e)(t.formatContainer.newFormat)&&F.a.setFirstValue(i,"dc.format",t.formatContainer.newFormat),e.metadata=i,e}onCancel(){this.navigateToItemEditBitstreams()}navigateToItemEditBitstreams(){Object(f.b)(this.itemId)?this.router.navigate([Object(g.d)(this.entityType,this.itemId),"bitstreams"]):this.bitstream.bundle.pipe(Object(u.j)(),Object(l.a)(t=>t.item.pipe(Object(u.j)()))).subscribe(t=>{this.router.navigate([Object(g.e)(t),"bitstreams"])})}ngOnDestroy(){this.subs.filter(t=>Object(f.b)(t)).forEach(t=>t.unsubscribe())}}return t.\u0275fac=function(e){return new(e||t)(v["\u0275\u0275directiveInject"](r.a),v["\u0275\u0275directiveInject"](r.g),v["\u0275\u0275directiveInject"](a.o),v["\u0275\u0275directiveInject"](c.F),v["\u0275\u0275directiveInject"](I.f),v["\u0275\u0275directiveInject"](y.a),v["\u0275\u0275directiveInject"](w.a),v["\u0275\u0275directiveInject"](C.a))},t.\u0275cmp=v["\u0275\u0275defineComponent"]({type:t,selectors:[["ds-edit-bitstream-page"]],decls:3,vars:3,consts:[[4,"ngVar"],["class","container",4,"ngVar"],[1,"container"],["class","row",4,"ngIf"],[3,"message",4,"ngIf"],[1,"row"],[1,"col-md-2"],[3,"thumbnail"],[1,"col-md-10"],[1,"col-12"],[1,"text-muted"],[3,"formId","formGroup","formModel","formLayout","submitLabel","submitForm","cancel","dfChange"],[3,"message"]],template:function(t,e){1&t&&(v["\u0275\u0275template"](0,V,5,3,"ng-container",0),v["\u0275\u0275pipe"](1,"async"),v["\u0275\u0275text"](2,"\n")),2&t&&v["\u0275\u0275property"]("ngVar",v["\u0275\u0275pipeBind1"](1,1,e.bitstreamRD$))},directives:[j.a,a.u,O.a,M.a,S.NgControlStatusGroup,S.FormGroupDirective,x.a,E.a],pipes:[a.b,N.a,I.e],styles:["[_nghost-%COMP%]     .switch{position:absolute;top:calc(var(--bs-spacer) * 2.5)}"],changeDetection:0}),t})();var _=i("tPZA"),R=i("84Zn");let X=(()=>{class t{constructor(t){this.bitstreamService=t}resolve(t,e){return this.bitstreamService.findById(t.params.id,!0,!1,...this.followLinks).pipe(Object(u.g)())}get followLinks(){return[Object(R.a)("bundle",void 0,!0,!0,!0,Object(R.a)("item")),Object(R.a)("format")]}}return t.\u0275fac=function(e){return new(e||t)(v["\u0275\u0275inject"](y.a))},t.\u0275prov=v["\u0275\u0275defineInjectable"]({token:t,factory:t.\u0275fac}),t})();var D=i("Gt6B");let G=(()=>{class t{}return t.\u0275mod=v["\u0275\u0275defineNgModule"]({type:t}),t.\u0275inj=v["\u0275\u0275defineInjector"]({factory:function(e){return new(e||t)},providers:[X],imports:[[r.k.forChild([{path:":id/download",component:D.a,resolve:{bitstream:X}},{path:":id/edit",component:k,resolve:{bitstream:X},canActivate:[_.a]}])]]}),t})(),A=(()=>{class t{}return t.\u0275mod=v["\u0275\u0275defineNgModule"]({type:t}),t.\u0275inj=v["\u0275\u0275defineInjector"]({factory:function(e){return new(e||t)},imports:[[a.c,n.a,G]]}),t})()}}]);
//# sourceMappingURL=38-es2015.cb2bba9d646df0e0df24.js.map